@model NiceHandles.Models.Job
@using NiceHandles.Models;
@using Microsoft.AspNet.Identity;
@{
    var db = (NiceHandles.Models.NHModel)ViewBag.db;
    var username = User.Identity.GetUserName();
    var acc = db.Accounts.Where(x => x.UserName.Equals(username)).Single();
}

<h2>@ViewBag.Title</h2>

@using (Html.BeginForm())
{
    @Html.AntiForgeryToken()

    <div class="form-horizontal">
        <h4>Nhiệm vụ</h4>
        <hr />
        @Html.HiddenFor(model => model.created_by, new { @Value = acc.id })
        @Html.HiddenFor(model => model.status, new { @Value = (int)XJob.eStatus.Processing })

        @Html.ValidationSummary(true, "", new { @class = "text-danger" })

        <div class="form-group">
            @Html.Label("Tên Issue", new { @class = "control-label col-md-2" })
            <div class="col-md-10">
                @Html.EditorFor(model => model.name, new { htmlAttributes = new { @class = "form-control" } })
                @Html.ValidationMessageFor(model => model.name, "", new { @class = "text-danger" })
            </div>
        </div>


        <div class="form-group">
            @Html.Label("Ngày bắt đầu", new { @class = "control-label col-md-2" })
            <div class="col-md-10">
                @Html.EditorFor(model => model.start_date, new { htmlAttributes = new { @class = "form-control datetime", autocomplete = "off" } })
                @Html.ValidationMessageFor(model => model.start_date, "", new { @class = "text-danger" })
            </div>
        </div>

        <div class="form-group">
            @Html.Label("Ngày hạn", new { @class = "control-label col-md-2" })
            <div class="col-md-10">
                @Html.EditorFor(model => model.exp_date, new { htmlAttributes = new { @class = "form-control datetime", autocomplete = "off" } })
                @Html.ValidationMessageFor(model => model.exp_date, "", new { @class = "text-danger" })
            </div>
        </div>

        <div class="form-group">
            @Html.Label("Người thực hiện", new { @class = "control-label col-md-2" })
            <div class="col-md-10">
                @Html.DropDownListFor(model => model.process_by, ViewBag.ACCOUNTS as SelectList, new { @class = "form-control" })
                @Html.ValidationMessageFor(model => model.process_by, "", new { @class = "text-danger" })
            </div>
        </div>

        <div class="form-group">
            @Html.Label("Kết quả", new { @class = "control-label col-md-2" })
            <div class="col-md-10">
                @Html.TextAreaFor(model => model.note, new { @class = "form-control" })
                @Html.ValidationMessageFor(model => model.note, "", new { @class = "text-danger" })
            </div>
        </div>

        <fieldset style="background-color: aliceblue;">
            <div class="form-group">
                @Html.Label("Hồ sơ", new { @class = "control-label col-md-2" })
                <div class="col-md-10">
                    @Html.DropDownListFor(x => x.hoso_id, new SelectList(new progress_file[0]), "Hồ sơ", new { @class = "form-control" })
                </div>
            </div>
            <div class="form-group">
                @Html.Label("Thư mục", new { @class = "control-label col-md-2" })
                <div class="col-md-10">
                    @Html.DropDownListFor(x => x.progress_type, new SelectList(XProgress.sType, "Key", "Value"), new { @class = "form-control" })
                </div>
            </div>
            <div class="form-group">
                @Html.Label("Loại chuông", new { @class = "control-label col-md-2" })
                <div class="col-md-10">
                    @Html.DropDownListFor(x => x.label, new SelectList(XProgress.sBellType, "Key", "Value"), "Loại chuông", new { @class = "form-control" })
                </div>
            </div>
        </fieldset>
        <div class="form-group">
            <div class="col-md-offset-2 col-md-10">
                <input type="submit" value="Thêm mới" class="btn btn-default" />
            </div>
        </div>
    </div>
}

<div>
    @Html.ActionLink("Về danh sách", "Issue")
</div>
@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    <script>
        $(document).ready(function () {
            $(".datetime").datepicker({
                "autoclose": true,
                "todayHighlight": true,
                "dateFormat": "dd/mm/yyyy",
                "format": "dd/mm/yyyy",
            }).datepicker("setDate", new Date());
            var currentDate = new Date();
            currentDate.setDate(currentDate.getDate() + 1);
            $("#exp_date").datepicker("setDate", currentDate);
            SetSelect2("#hoso_id", "/Hosoes/GetHosoService", "VD: Nguyễn Văn A");
            $("#hoso_id").change(function () {
                if (!$("#name").val() || $("#name").val() == '') {
                    var data = $('#hoso_id').select2('data');
                    $("#name").val(data[0].name + " - " + data[0].text);
                }
            });
            $('#hoso_id').on('select2:select', function (e) {
                $("#name").select().focus();
            });
        });
        $(function () {
            $.validator.methods.date = function (value, element) {
                return this.optional(element) || moment(value, "DD/MM/YYYY", true).isValid();
            }
        });
    </script>
}
