@model NiceHandles.Models.HoSo
@using NiceHandles.Models
@{
    var db = new NHModel();
    ViewBag.Title = "Index";

    var contract = db.Contracts.Find(Model.contract_id);
    var service = db.Services.Find(Model.service_id);
    var address = db.Addresses.Find(contract.address_id);
    var currentstep = db.Steps.Find(Model.step_id);
    var nextstep = db.Steps.Find(currentstep.next);
    var index = 0;
    var cuochop = db.CuocHops.Where(x => x.hoso_id == Model.id).ToArray();
    var accounts = db.Accounts.Where(x => x.sta == (int)XAccount.eStatus.Processing).ToArray();

}
<div class="row">
    <div class="col-md-6">
        <h2>
            @Html.Raw(Model.name)
            <a href='/Infomations/Edit?hoso_id=@Model.id' style="font-size:14px; font-style: italic;" class="text-danger">
                <i style="font-size: large" class="fa fa-regular fa-keyboard"></i>
                Nhập thông tin
            </a>
        </h2>
        <div class="row">
            <div class="col-md-3">
                <p>
                    Dịch vụ: <i> @service.name</i>
                </p>
                <p>
                    Địa chỉ: <i>@Html.Raw(address.name)</i>
                </p>
                <p>
                    SĐT: <i>@Html.Raw(contract.sodienthoai + " " + contract.sodienthoai_mota)</i>
                </p>
            </div>
            <div class="col-md-3">
                @{
                    var phutrach = db.Accounts.Find(Model.account_id);
                    var soanthao = db.Accounts.Find(Model.account_id_soanthao);
                }
                <p>
                    Phụ trách: <i>@phutrach.fullname</i><a onclick="ShowModalPhuTrach();" href="#"> <i class="fa fa-edit"></i></a>
                </p>
                <p>
                    Soạn thảo: <i>@Html.Raw(soanthao != null ? soanthao.fullname : "---")</i> <a onclick="ShowModalSoanThao();" href="#"> <i class="fa fa-edit"></i></a>
                </p>
            </div>
            <div class="col-md-6" style="text-align:center">
                <h4>CUỘC HỌP</h4>
                <p>
                    @Html.ActionLink(" Thêm mới ", "create", "cuochops", new { id = Model.id }, new { @class = "fa fa-plus" }) &nbsp;|&nbsp;
                    @foreach (var item in cuochop)
                    {
                        @Html.ActionLink(item.name + " | ", "details", "cuochops", new { id = item.id }, null)
                    }
                </p>
            </div>
        </div>
    </div>
    <div class="col-md-6" style="text-align: right; padding-top: 15px;">
        <p>
            <label> <a href="/Contracts/Details/@Model.contract_id">Xem hợp đồng </a> | Bước hiện tại: <span class="text-danger"> @currentstep.name</span></label>
            @if (nextstep != null)
            {
                <label> | Bước tiếp là: <span class="text-danger"> @nextstep.name </span></label>
            }
        </p>
        <p>
            @foreach (var item in db.Steps.OrderBy(x => x.sort))
            {
                index++;
                if (item.id == currentstep.id)
                {
                    <b> <i title="@item.description" style="color: @item.color"> @Html.Raw(index.ToString() + ", " + item.name + " -> ") </i></b>
                }
                else
                {
                    <span title="@item.description" style="color: @item.color"> @Html.Raw(index.ToString() + ", " + item.name + " -> ")</span>
                }
            }
        </p>
        @Html.ActionLink("Trả về", "Prev", "hosoes", new { hoso_id = Model.id }, new { @class = "btn btn-danger" })
        @Html.ActionLink("Bước tiếp", "Next", "hosoes", new { hoso_id = Model.id }, new { @class = "btn btn-info" })
    </div>
</div>
<div class="row">
    <div class="col-md-6">
        @Html.Partial("../Progresses/NhiemVu", Model)
        @Html.Partial("../Progresses/DieuTra", Model)
        @Html.Partial("../Progresses/GiaPha", Model)
        @Html.Partial("../Progresses/BanVe", Model)
        @Html.Partial("../Progresses/HoTich", Model)
        @Html.Partial("../Progresses/CongChung", Model)
        @Html.Partial("../Progresses/Town", Model)
        @Html.Partial("../Progresses/DonThu", Model)
    </div>
    <div class="col-md-6">
        @Html.Partial("../Progresses/CheckListCongViec", Model)
        @Html.Partial("../Progresses/HDDichVu", Model)
        @Html.Partial("../Progresses/HDBuoc", Model)

        @Html.Partial("../Progresses/GhiChuQuaTrinh", Model)
    </div>
</div>
@Html.Partial("../Shared/Modals/_ModalNH")
<div id="mdlSoanThao" class="modal" role="dialog" tabindex="-1">
    <div class="modal-dialog modal-sm" role="document">
        <div class="modal-content">
            @using (Html.BeginForm("UpdateSoanThao", "Hosoes", FormMethod.Post))
            {
                <div class="modal-body">
                    @Html.Hidden("hsId", Model.id)
                    @Html.DropDownList("ddlSoanThao", new SelectList(accounts, "id", "fullname", Model.account_id_soanthao), new { @class = "form-control" })
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Cập nhật</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                </div>
            }
        </div>
    </div>
</div>
<div id="mdlUpdatePhuTrach" class="modal" role="dialog" tabindex="-1">
    <div class="modal-dialog modal-sm" role="document">
        <div class="modal-content">
            @using (Html.BeginForm("UpdatePhuTrach", "Hosoes", FormMethod.Post))
            {
                <div class="modal-body">
                    @Html.Hidden("hsId", Model.id)
                    @Html.DropDownList("ddlPhuTrach", new SelectList(accounts, "id", "fullname", Model.account_id), new { @class = "form-control" })
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Cập nhật</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                </div>
            }
        </div>
    </div>
</div>
<iframe id="my_iframe" style="display:none;"></iframe>
@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    <script>
        $(document).ready(function () {
            ReloadViecPhaiLam(@Model.id, @((int)XProgress.eType.NhiemVu ));
            ReloadViecPhaiLam(@Model.id, @((int)XProgress.eType.DieuTra ));
            ReloadViecPhaiLam(@Model.id, @((int)XProgress.eType.GiaPha));
            ReloadViecPhaiLam(@Model.id, @((int)XProgress.eType.BanVe));
            ReloadViecPhaiLam(@Model.id, @((int)XProgress.eType.GiayToHoTich));
            ReloadViecPhaiLam(@Model.id, @((int)XProgress.eType.CongChung));
            ReloadViecPhaiLam(@Model.id, @((int)XProgress.eType.GiayToXa));
            ReloadViecPhaiLam(@Model.id, @((int)XProgress.eType.DonThu));
            ReloadViecPhaiLam(@Model.id, @((int)XProgress.eType.GhiChu));
            ReloadDonThu(@Model.id, @((int)XProgress.eType.DonThu));
        });
        // OLD
        function InCongViec(hoso_id,service_id) {
            $.ajax({
                url: '/Services/InCongViec',
                data: {
                    hoso_id: hoso_id,
                    service_id: service_id
                },
                type: "GET",
                dataType: "JSON",
                success: function (url) {
                    document.getElementById('my_iframe').src = url;
                }
            });
        }
        function CVChange(ctr, cvid) {
            var check = ctr.checked;
            var hoso_id = @Model.id;
            $.ajax({
                url: '/CongViecs/Update',
                type: "POST",
                dataType: "JSON",
                data: { hoso_id: hoso_id, congviec_id: cvid, check : check },
                success: function () {
                    toastr.success("Đã cập nhật", "THÀNH CÔNG", { timeOut: 3000 });
                }
            });
        }
        function Save1Cua() {
            var obj = new Object();
            obj.id = $("[name=1cid]").val();
            obj.hoso_id = $("[name=1choso_id]").val();
            obj.ngaynop = $("[name=1cngaynop]").val();
            obj.ngaytra = $("[name=1cngaytra]").val();
            obj.canbo1cua = $("[name=1ccanbo1cua]").val();
            obj.noinhan_id = $("[name=1cnoinhan]").val();
            obj.maphieuhen = $("[name=1cmaphieuhen]").val();
            obj.trangthai = $("[name=1ctrangthai]").val();
            obj.ghichu = $("[name=1cghichu]").val();
            $.ajax({
                url: '/di1cua/Save',
                type: "POST",
                dataType: "JSON",
                data: { di1cua: obj, ngaynop: obj.ngaynop, ngaytra: obj.ngaytra },
                success: function () {
                    toastr.options = {
                        "preventDuplicates": true,
                        "preventOpenDuplicates": true
                    };
                    toastr.success("Đã lưu đi 1 cửa", "HỒ SƠ", { timeOut: 5000 });
                }
            });
        }
        function ShowModalSoanThao() {
            $("#mdlSoanThao").modal("show");
        }
        function ShowModalPhuTrach() {
            $("#mdlUpdatePhuTrach").modal("show");
        }
    </script>
}
