@model PagedList.IPagedList<NiceHandles.Models.vInOut>
@using PagedList.Mvc;
@using NiceHandles.Models
@using Microsoft.AspNet.Identity;
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewBag.Title = "Thu chi";
    var db = new NHModel();
    var types = new SelectList(XCategory.sType, "Key", "Value");
    var username = User.Identity.GetUserName();
    var us = db.Accounts.Where(x => x.UserName.Equals(username)).Single();
    ViewBag.ACCOUNTS = db.Accounts.Where(x => x.sta == (int)XAccount.eStatus.Processing);
}
<link href="~/Content/inouts-style.css" rel="stylesheet" />
<link href="~/Content/contractselect2.css" rel="stylesheet" />
<h2>
    <i class="fa fa-coins"></i> Quản lý thu chi
</h2>

<div class="row">
    <!-- Cột trái: Form nhập liệu -->
    <div class="col-md-6">
        <!-- Nav tabs -->
        <div class="nav-tabs-custom">
            <ul class="nav nav-tabs" role="tablist">
                <li role="presentation" class="active">
                    <a href="#thu-tab" aria-controls="thu-tab" role="tab" data-toggle="tab">
                        <i class="fa fa-arrow-down text-success"></i> Phiếu Thu
                    </a>
                </li>
                <li role="presentation">
                    <a href="#chi-tab" aria-controls="chi-tab" role="tab" data-toggle="tab">
                        <i class="fa fa-arrow-up text-danger"></i> Phiếu Chi
                    </a>
                </li>
            </ul>

            <!-- Tab panes -->
            <div class="tab-content">
                <!-- Tab Thu -->
                <div role="tabpanel" class="tab-pane active" id="thu-tab">
                    @using (Html.BeginForm("Index", "InOuts", FormMethod.Post, new { @id = "formThu" }))
                    {
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="type" value="@((int)XCategory.eType.Thu)" />
                        <input type="hidden" name="time" value="@DateTime.Now" />

                        <div class="form-section">
                            <h4 class="text-success"><i class="fa fa-plus-circle"></i> Tạo phiếu thu mới</h4>

                            <!-- Chọn loại thu -->
                            <div class="form-group">
                                <label>Loại thu:</label>
                                <div class="btn-group btn-group-toggle btn-group-justified" data-toggle="buttons">
                                    <label class="btn btn-default active">
                                        <input type="radio" name="thuType" value="contract" checked>
                                        <i class="fa fa-file-text-o"></i> Trong hợp đồng
                                    </label>
                                    <label class="btn btn-default">
                                        <input type="radio" name="thuType" value="outside">
                                        <i class="fa fa-building-o"></i> Ngoài hợp đồng
                                    </label>
                                </div>
                            </div>

                            <!-- Section chọn hợp đồng -->
                            <div class="contract-section" id="thuContractSection" style="display: block;">
                                <div class="form-group">
                                    <label>Chọn hợp đồng <span class="text-danger">*</span></label>
                                    <select name="contract_id" id="thuContractId" class="form-control select2-contract" style="width: 100%;">
                                        <option value="">-- Chọn hợp đồng --</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Loại thu chi tiết -->
                            <div class="form-group">
                                <label>Loại thu chi tiết <span class="text-danger">*</span></label>
                                <select name="category_id" id="thuCategoryId" class="form-control" required>
                                    <option value="">-- Chọn loại thu --</option>
                                </select>
                            </div>

                            <!-- Người thu -->
                            <div class="form-group">
                                <label>Người thu <span class="text-danger">*</span></label>
                                <select name="account_id" class="form-control" required>
                                    <option value="">-- Chọn người thu --</option>
                                    @foreach (var acc in ViewBag.ACCOUNTS)
                                    {
                                        <option value="@acc.id" @(acc.id == us.id ? "selected" : "")>@acc.fullname</option>
                                    }
                                </select>
                            </div>

                            <!-- Số tiền và loại tiền -->
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="form-group">
                                        <label>Số tiền <span class="text-danger">*</span></label>
                                        <input type="text" id="thuAmount" class="form-control text-right money-input" placeholder="0" required />
                                        <input type="hidden" name="amount" id="thuAmountHidden" />
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Hình thức</label>
                                        <select name="currency" class="form-control">
                                            <option value="@((int)XModels.eLoaiTien.TienMat)">Tiền mặt</option>
                                            <option value="@((int)XModels.eLoaiTien.NganHang)">Chuyển khoản</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Ghi chú -->
                            <div class="form-group">
                                <label>Ghi chú</label>
                                <textarea name="note" class="form-control" rows="2" placeholder="Nhập ghi chú..."></textarea>
                            </div>

                            <!-- Nút submit -->
                            <div class="form-group">
                                <button type="submit" class="btn btn-thu btn-lg btn-block">
                                    <i class="fa fa-save"></i> Thực hiện thu
                                </button>
                            </div>
                        </div>
                    }
                </div>

                <!-- Tab Chi -->
                <div role="tabpanel" class="tab-pane" id="chi-tab">
                    @using (Html.BeginForm("Index", "InOuts", FormMethod.Post, new { @id = "formChi" }))
                    {
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="type" value="@((int)XCategory.eType.Chi)" />
                        <input type="hidden" name="time" value="@DateTime.Now" />

                        <div class="form-section">
                            <h4 class="text-danger"><i class="fa fa-minus-circle"></i> Tạo phiếu chi mới</h4>

                            <!-- Chọn loại chi -->
                            <div class="form-group">
                                <label>Loại chi:</label>
                                <div class="btn-group btn-group-toggle btn-group-justified" data-toggle="buttons">
                                    <label class="btn btn-default active">
                                        <input type="radio" name="chiType" value="contract" checked>
                                        <i class="fa fa-file-text-o"></i> Trong hợp đồng
                                    </label>
                                    <label class="btn btn-default">
                                        <input type="radio" name="chiType" value="outside">
                                        <i class="fa fa-building-o"></i> Ngoài hợp đồng
                                    </label>
                                </div>
                            </div>

                            <!-- Section chọn hợp đồng -->
                            <!-- Trong tab Chi, sau phần chọn hợp đồng -->
                            <div class="contract-section" id="chiContractSection" style="display: block;">
                                <div class="form-group">
                                    <label>Chọn hợp đồng <span class="text-danger">*</span></label>
                                    <select name="contract_id" id="chiContractId" class="form-control select2-contract" style="width: 100%;">
                                        <option value="">-- Chọn hợp đồng --</option>
                                    </select>
                                </div>

                                <!-- THÔNG TIN HỢP ĐỒNG - ĐẢM BẢO ĐÚNG CẤU TRÚC -->
                                <div id="contractFinancialInfo" style="display: none; margin-top: 15px;">
                                    <div class="panel panel-info">
                                        <div class="panel-heading">
                                            <h4 class="panel-title">
                                                <i class="fa fa-info-circle"></i> Thông tin thu chi hợp đồng: <span id="contractName">Đang tải...</span>
                                            </h4>
                                        </div>
                                        <div class="panel-body">
                                            <!-- Phần này sẽ được update bằng JavaScript -->
                                            <div id="contractContent">
                                                <div class="text-center">
                                                    <i class="fa fa-spinner fa-spin"></i> Đang tải thông tin...
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Loại chi chi tiết -->
                            <div class="form-group">
                                <label>Loại chi chi tiết <span class="text-danger">*</span></label>
                                <select name="category_id" id="chiCategoryId" class="form-control" required>
                                    <option value="">-- Chọn loại chi --</option>
                                </select>
                            </div>

                            <!-- Người chi -->
                            <div class="form-group">
                                <label>Người nhận chi <span class="text-danger">*</span></label>
                                <select name="account_id" class="form-control" required>
                                    <option value="">-- Chọn người nhận --</option>
                                    @foreach (var acc in ViewBag.ACCOUNTS)
                                    {
                                        <option value="@acc.id">@acc.fullname</option>
                                    }
                                </select>
                            </div>

                            <!-- Số tiền và loại tiền -->
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="form-group">
                                        <label>Số tiền <span class="text-danger">*</span></label>
                                        <input type="text" id="chiAmount" class="form-control text-right money-input" placeholder="0" required />
                                        <input type="hidden" name="amount" id="chiAmountHidden" />
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Hình thức</label>
                                        <select name="currency" class="form-control">
                                            <option value="@((int)XModels.eLoaiTien.TienMat)">Tiền mặt</option>
                                            <option value="@((int)XModels.eLoaiTien.NganHang)">Chuyển khoản</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Ghi chú -->
                            <div class="form-group">
                                <label>Ghi chú</label>
                                <textarea name="note" class="form-control" rows="2" placeholder="Nhập ghi chú..."></textarea>
                            </div>

                            <!-- Nút submit -->
                            <div class="form-group">
                                <button type="submit" class="btn btn-chi btn-lg btn-block">
                                    <i class="fa fa-save"></i> Chuyển duyệt chi
                                </button>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Cột phải: Thống kê -->
    <div class="col-md-6">
        <!-- Thống kê tổng quan -->
        <div class="row">
            <div class="col-md-6">
                <div class="stat-box" style="border-left: 3px solid #28a745;">
                    <h4><i class="fa fa-arrow-down text-success"></i> TỔNG THU</h4>
                    <div class="value text-success">@ViewBag.TONGTHU</div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="stat-box" style="border-left: 3px solid #dc3545;">
                    <h4><i class="fa fa-arrow-up text-danger"></i> TỔNG CHI</h4>
                    <div class="value text-danger">@ViewBag.TONGCHI</div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="stat-box" style="border-left: 3px solid #17a2b8;">
                    <h4><i class="fa fa-balance-scale"></i> THU - CHI</h4>
                    <div class="value text-info">@ViewBag.THUCHI</div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="stat-box" style="border-left: 3px solid #007bff;">
                    <h4><i class="fa fa-university"></i> TIỀN NGÂN HÀNG</h4>
                    <div class="value text-primary">@ViewBag.NGANHANG</div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="stat-box" style="border-left: 3px solid #28a745;">
                    <h4><i class="fa fa-coins"></i> TIỀN MẶT</h4>
                    <div class="value text-success">@ViewBag.TIENMAT</div>
                </div>
            </div>
        </div>

        <!-- Các nút chức năng -->
        <div class="row" style="margin-top: 20px;">
            <div class="col-md-12">
                <a href="/InOuts/CongNo" class="btn btn-warning btn-block">
                    <i class="fa fa-book"></i> Sổ công nợ
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Phần tìm kiếm và danh sách -->
<div style="margin-top: 30px;">
    <h3><i class="fa fa-list"></i> Danh sách thu chi</h3>

    @using (Html.BeginForm("Index", "InOuts", FormMethod.Get))
    {
        <div class="panel panel-default">
            <div class="panel-body">
                <div class="row">
                    <div class="col-sm-2">
                        <div class="form-group">
                            @Html.TextBox("fromdate", ViewBag.FROMDATE as string, new { @class = "form-control datetime", placeholder = "Từ ngày", autocomplete = "off" })
                        </div>
                    </div>
                    <div class="col-sm-2">
                        <div class="form-group">
                            @Html.TextBox("todate", ViewBag.TODATE as string, new { @class = "form-control datetime", placeholder = "Đến ngày", autocomplete = "off" })
                        </div>
                    </div>
                    <div class="col-sm-2">
                        <div class="form-group">
                            @Html.DropDownList("s_account_id", new SelectList(ViewBag.ACCOUNTS, "id", "fullname"), "-- Tất cả --", new { @class = "form-control" })
                        </div>
                    </div>
                    <div class="col-sm-1">
                        <div class="form-group">
                            @Html.DropDownList("s_type", XCategory.sType.Select(x => new SelectListItem { Value = x.Key.ToString(), Text = x.Value }), "Loại", new { @class = "form-control", @onchange = "s_FillCategory()" })
                        </div>
                    </div>
                    <div class="col-sm-2">
                        <div class="form-group">
                            @Html.DropDownList("s_category_id", new SelectListItem[0], "-- Chi tiết --", new { @class = "form-control" })
                        </div>
                    </div>
                    <div class="col-sm-1">
                        <div class="form-group">
                            @Html.DropDownList("s_currency", new SelectList(XModels.sLoaiTien, "Key", "Value"), "Hình thức", new { @class = "form-control" })
                        </div>
                    </div>
                    <div class="col-sm-2">
                        <div class="form-group">
                            @Html.TextBox("Search_Data", ViewBag.FilterValue as string, new { @class = "form-control", placeholder = "Tìm ghi chú" })
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-12">
                        <button type="submit" class="btn btn-primary"><i class="fa fa-search"></i> Tìm kiếm</button>
                        <button type="button" class="btn btn-default" onclick="Print();"><i class="fa fa-print"></i> In báo cáo</button>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Bảng danh sách -->
    <table class="table table-hover table-striped">
        <thead>
            <tr>
                <th width="10%">Thời gian</th>
                <th width="15%">Hợp đồng</th>
                <th width="15%">Người thực hiện</th>
                <th width="5%">Loại</th>
                <th width="15%">Loại chi tiết</th>
                <th width="5%">Hình thức</th>
                <th width="10%" class="text-right">Số tiền</th>
                <th width="20%">Ghi chú</th>
                <th width="5%">Trạng thái</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @for (int i = 0; i < Model.Count; i++)
            {
                string contract_name = string.Empty;
                if (Model[i].contract_id.HasValue)
                {
                    var contract = db.Contracts.Find(Model[i].contract_id.Value);
                    contract_name = contract?.name ?? "";
                }

                <tr>
                    <td>@Model[i].time.ToString("dd/MM/yyyy")</td>
                    <td>
                        @if (!string.IsNullOrEmpty(contract_name))
                        {
                            <a href="/Contracts/Details/@Model[i].contract_id">@contract_name</a>
                        }
                    </td>
                    <td>@Html.ActionLink(Model[i].disname, "Details", new { id = Model[i].id })</td>
                    <td>
                        @if (Model[i].type == (int)XCategory.eType.Thu)
                        {
                            <span class="label label-success">Thu</span>
                        }
                        else
                        {
                            <span class="label label-danger">Chi</span>
                        }
                    </td>
                    <td>@Html.Raw(Model[i].name)</td>
                    <td>
                        @if (Model[i].currency == (int)XModels.eLoaiTien.TienMat)
                        {
                            <i class="fa fa-coins text-success" title="Tiền mặt"></i>
                        }
                        else
                        {
                            <i class="fa fa-credit-card text-primary" title="Chuyển khoản"></i>
                        }
                    </td>
                    <td class="text-right">
                        @if (Model[i].type == (int)XCategory.eType.Thu)
                        {
                            <span class="text-success">+@Model[i].amount.ToString("N0")</span>
                        }
                        else
                        {
                            <span class="text-danger">-@Model[i].amount.ToString("N0")</span>
                        }
                    </td>
                    <td>@Model[i].note</td>
                    <td>
                        @if (Model[i].status == (int)XInOut.eStatus.ChoDuyet)
                        {
                            <span class="label label-warning">Chờ duyệt</span>
                        }
                        else if (Model[i].status == (int)XInOut.eStatus.DaDuyet)
                        {
                            <span class="label label-info">Đã duyệt</span>
                        }
                        else if (Model[i].status == (int)XInOut.eStatus.DaThucHien)
                        {
                            <span class="label label-success">Hoàn thành</span>
                        }
                        else
                        {
                            @Html.Raw(XInOut.sStatus[Model[i].status])
                        }
                    </td>
                    <td>
                        @if (Model[i].status == (int)XInOut.eStatus.ChoDuyet)
                        {
                            <a href="#" class="del text-danger" id="del@(Model[i].id)" title="Hủy phiếu">
                                <i class="fa fa-times"></i>
                            </a>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <!-- Phân trang -->
    @if (Model.PageCount > 1)
    {
        <div class="row" style="margin-top: 10px;">
            <div class="col-sm-2">
                Trang @(Model.PageCount < Model.PageNumber ? 0 : Model.PageNumber) / @Model.PageCount
            </div>
            <div class="col-sm-10">
                @Html.PagedListPager(Model, Page_No => Url.Action("Index", new
                {
                    Page_No,
                    Filter_Value = ViewBag.FilterValue,
                    s_account_id = ViewBag.account_id,
                    s_category_id = ViewBag.category_id,
                    s_type = ViewBag.type,
                    s_currency = ViewBag.currency,
                    fromdate = ViewBag.FROMDATE,
                    todate = ViewBag.TODATE
                }))
            </div>
        </div>
    }
</div>

<!-- Modal xác nhận xóa -->
<div id="password" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Xác nhận hủy phiếu</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <p>Vui lòng nhập mật khẩu để xác nhận hủy phiếu:</p>
                <input type="password" class="form-control" id="txtPassword" />
                <span class="text-danger hide forPassword">Sai mật khẩu!</span>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="confirmed()">Xác nhận</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<iframe id="my_iframe" style="display:none;"></iframe>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    <script src="~/Scripts/contractselect2.js"></script>
    <script>
        var currentDelCtr = null;

        $(document).ready(function () {
            // Khởi tạo datepicker
            $(".datetime").datepicker({
                autoclose: true,
                todayHighlight: true,
                format: "dd/mm/yyyy"
            });

            // Khởi tạo select2 cho hợp đồng
            

            // Khởi tạo autoNumeric cho input tiền
            $('.money-input').autoNumeric('init', {
                aSep: ',',
                aDec: '.',
                mDec: '0'
            });

            // Load categories ban đầu
            loadCategories(@((int)XCategory.eType.Thu), '#thuCategoryId', @((int)XCategory.eParent.KhachHang));
            loadCategories(@((int)XCategory.eType.Chi), '#chiCategoryId', @((int)XCategory.eParent.KhachHang));

            // Xử lý radio button Thu
            $('input[name="thuType"]').change(function() {
                if ($(this).val() === 'contract') {
                    $('#thuContractSection').slideDown();
                    $('#thuContractId').attr('required', true);
                    loadCategories(@((int)XCategory.eType.Thu), '#thuCategoryId', @((int)XCategory.eParent.KhachHang));
                } else {
                    $('#thuContractSection').slideUp();
                    $('#thuContractId').attr('required', false).val(null).trigger('change');
                    loadCategories(@((int)XCategory.eType.Thu), '#thuCategoryId', @((int)XCategory.eParent.VanPhong));
                }
            });

            // Xử lý radio button Chi
            $('input[name="chiType"]').change(function() {
                if ($(this).val() === 'contract') {
                    $('#chiContractSection').slideDown();
                    $('#chiContractId').attr('required', true);
                    loadCategories(@((int)XCategory.eType.Chi), '#chiCategoryId', @((int)XCategory.eParent.KhachHang));
                } else {
                    $('#chiContractSection').slideUp();
                    $('#chiContractId').attr('required', false).val(null).trigger('change');
                    loadCategories(@((int)XCategory.eType.Chi), '#chiCategoryId', @((int)XCategory.eParent.VanPhong));
                }
            });

            // Submit form Thu
            $('#formThu').submit(function(e) {
                var amount = $('#thuAmount').autoNumeric('get');
                $('#thuAmountHidden').val(amount);

                if ($('input[name="thuType"]:checked').val() === 'contract' && !$('#thuContractId').val()) {
                    e.preventDefault();
                    alert('Vui lòng chọn hợp đồng!');
                    return false;
                }
            });

            // Submit form Chi
            $('#formChi').submit(function(e) {
                var amount = $('#chiAmount').autoNumeric('get');
                $('#chiAmountHidden').val(amount);

                if ($('input[name="chiType"]:checked').val() === 'contract' && !$('#chiContractId').val()) {
                    e.preventDefault();
                    alert('Vui lòng chọn hợp đồng!');
                    return false;
                }
            });

            // Xử lý xóa
            $(".del").click(function () {
                currentDelCtr = this;
                $("#password").modal("show");
                return false;
            });
        });

        // Load categories
        function loadCategories(type, targetId, parentId) {
            $.ajax({
                url: '/Categories/FillCategoryContract',
                type: "GET",
                dataType: "JSON",
                data: { type: type, parent_id: parentId },
                success: function (categories) {
                    $(targetId).html('<option value="">-- Chọn loại --</option>');
                    $.each(categories, function (i, cate) {
                        var bgColor = cate.duyet == 0 ? 'style="background-color:#d4edda;"' : '';
                        $(targetId).append($('<option ' + bgColor + '></option>').val(cate.id).html(cate.name));
                    });
                }
            });
        }

        // Format contract cho select2
        function formatContract(repo) {
            if (repo.loading) return repo.text;

            var $container = $(
                "<div class='select2-result-repository clearfix'>" +
                "   <div class='select2-result-repository__meta'>" +
                "       <div class='select2-result-repository__title'></div>" +
                "       <div class='select2-result-repository__description'></div>" +
                "   </div>" +
                "</div>"
            );

            $container.find(".select2-result-repository__title").text(repo.name || repo.text);
            $container.find(".select2-result-repository__description").html(
                "<small class='text-muted'>" + (repo.text || '') + "</small>"
            );

            return $container;
        }

        function formatContractSelection(repo) {
            return repo.name || repo.text;
        }

        // Xác nhận xóa
        function confirmed() {
            var pass = $("#txtPassword").val();
            if (pass == "@Html.Raw(NiceHandles.Models.XModels.Password)") {
                $("#password").modal("hide");
                $.ajax({
                    url: '/Inouts/JDeleteConfirmed',
                    type: "GET",
                    dataType: "JSON",
                    data: { id: (currentDelCtr.id).replace("del","") },
                    success: function (rs) {
                        if (rs == true) {
                            $(currentDelCtr).closest('tr').fadeOut();
                            location.reload();
                        }
                    }
                });
            } else {
                $(".forPassword").removeClass("hide");
            }
        }

        // Fill category cho search
        function s_FillCategory() {
            var cate = $('#s_type').val();
            if (!cate || cate == "") {
                $("#s_category_id").html($('<option></option>').val("").html("-- Chi tiết --"));
            } else {
                $.ajax({
                    url: '/Categories/FillCategory',
                    type: "GET",
                    dataType: "JSON",
                    data: { cate: cate },
                    success: function (categories) {
                        $("#s_category_id").html("");
                        $("#s_category_id").append($('<option></option>').val("").html("-- Chi tiết --"));
                        $.each(categories, function (i, cate) {
                            $("#s_category_id").append($('<option></option>').val(cate.id).html(cate.name));
                        });
                    }
                });
            }
        }

        // In báo cáo
        function Print() {
            var Search_Data = $("#Search_Data").val();
            var account_id = $("#s_account_id").val();
            var type = $("#s_type").val();
            var category_id = $("#s_category_id").val();
            var currency = $("#s_currency").val();
            var fromdate = $("#fromdate").val();
            var todate = $("#todate").val();

            $.ajax({
                url: '/Inouts/BanInThuChi',
                data: {
                    Search_Data: Search_Data,
                    account_id: account_id,
                    type: type,
                    category_id: category_id,
                    currency: currency,
                    fromdate: fromdate,
                    todate: todate
                },
                type: "GET",
                dataType: "JSON",
                success: function (url) {
                    document.getElementById('my_iframe').src = url;
                }
            });
        }
        //
        // Thêm vào section Scripts

// Xử lý khi chọn hợp đồng trong tab Chi
$('#chiContractId').change(function() {
    var contractId = $(this).val();
    if (contractId) {
        loadContractFinancialInfo(contractId);
        loadCategoriesByContract(contractId);
    } else {
        $('#contractFinancialInfo').slideUp();
        loadCategories(@((int)XCategory.eType.Chi), '#chiCategoryId', @((int)XCategory.eParent.KhachHang));
    }
});

    // Thay thế hàm loadContractFinancialInfo và updateContractFinancialDisplay

    function loadContractFinancialInfo(contractId) {
        console.log('=== Loading contract info for ID:', contractId);

        // Hiển thị loading state
        $('#contractContent').html('<div class="text-center"><i class="fa fa-spinner fa-spin"></i> Đang tải thông tin...</div>');
        $('#contractFinancialInfo').show(); // Sử dụng show() thay vì slideDown()

        $.ajax({
            url: '/InOuts/GetContractFinancialInfo',
            type: 'GET',
            data: { contractId: contractId },
            dataType: 'json',
            success: function (response) {
                console.log('=== AJAX Success. Response:', response);

                if (response && response.success) {
                    console.log('=== Data valid, updating display...');
                    updateContractFinancialDisplay(response);
                } else {
                    console.log('=== Response not successful:', response);
                    $('#contractContent').html(
                        '<div class="alert alert-danger">' +
                        '<i class="fa fa-exclamation-triangle"></i> ' +
                        'Lỗi: ' + (response ? response.message : 'Dữ liệu không hợp lệ') +
                        '</div>'
                    );
                }
            },
            error: function (xhr, status, error) {
                console.log('=== AJAX Error:', status, error);
                console.log('=== Response Text:', xhr.responseText);

                $('#contractContent').html(
                    '<div class="alert alert-danger">' +
                    '<i class="fa fa-exclamation-triangle"></i> ' +
                    'Lỗi kết nối: ' + error +
                    '</div>'
                );
            }
        });
    }

    function updateContractFinancialDisplay(data) {
        console.log('=== Updating display with data:', data);

        try {
            const contract = data.contractInfo;
            const summary = data.summary;

            console.log('=== Contract info:', contract);
            console.log('=== Summary info:', summary);

            // Update tên hợp đồng
            $('#contractName').text(contract.name || 'N/A');

            // Tạo HTML đơn giản trước, phức tạp sau
            var htmlContent = `
            <div class="row">
                <div class="col-md-12">
                    <h4>Thông tin cơ bản</h4>
                    <table class="table table-bordered">
                        <tr>
                            <td><strong>Tên hợp đồng:</strong></td>
                            <td>${contract.name || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td><strong>Giá trị hợp đồng:</strong></td>
                            <td class="text-primary">${formatMoney(contract.amount || 0)}</td>
                        </tr>
                        <tr>
                            <td><strong>Tổng thu:</strong></td>
                            <td class="text-success">${formatMoney(summary.totalThu || 0)}</td>
                        </tr>
                        <tr>
                            <td><strong>Tổng chi:</strong></td>
                            <td class="text-danger">${formatMoney(summary.totalChi || 0)}</td>
                        </tr>
                        <tr>
                            <td><strong>Còn lại:</strong></td>
                            <td class="text-info">${formatMoney(summary.conLai || 0)}</td>
                        </tr>
                    </table>
                </div>
            </div>

            <div class="row">
                <div class="col-md-12">
                    <h4>Chi tiết các khoản chi</h4>
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Loại chi</th>
                                <th>Dự kiến</th>
                                <th>Đã chi</th>
                                <th>Còn lại</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Chi hoa hồng đối tác</td>
                                <td class="text-right">${formatMoney(contract.outrose || 0)}</td>
                                <td class="text-right text-danger">${formatMoney(summary.chiHoaHongDoiTac || 0)}</td>
                                <td class="text-right">${formatMoney((contract.outrose || 0) - (summary.chiHoaHongDoiTac || 0))}</td>
                            </tr>
                            <tr>
                                <td>Chi hoa hồng nhân viên</td>
                                <td class="text-right">${formatMoney(contract.rose || 0)}</td>
                                <td class="text-right text-danger">${formatMoney(summary.chiHoaHongNhanVien || 0)}</td>
                                <td class="text-right">${formatMoney((contract.rose || 0) - (summary.chiHoaHongNhanVien || 0))}</td>
                            </tr>
                            <tr>
                                <td>ĐM thực hiện</td>
                                <td class="text-right">${formatMoney(contract.remunerate || 0)}</td>
                                <td class="text-right text-danger">${formatMoney(summary.dmThucHien || 0)}</td>
                                <td class="text-right">${formatMoney((contract.remunerate || 0) - (summary.dmThucHien || 0))}</td>
                            </tr>
                            <tr>
                                <td>Tiền đo vẽ</td>
                                <td class="text-right">${formatMoney(contract.dove || 0)}</td>
                                <td class="text-right text-danger">${formatMoney(summary.tienDoVe || 0)}</td>
                                <td class="text-right">${formatMoney((contract.dove || 0) - (summary.tienDoVe || 0))}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        `;

            // Nếu có transactions, hiển thị
            if (data.transactions && data.transactions.length > 0) {
                htmlContent += `
                <div class="row">
                    <div class="col-md-12">
                        <h4>Giao dịch gần nhất</h4>
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Thời gian</th>
                                    <th>Loại</th>
                                    <th>Số tiền</th>
                                    <th>Ghi chú</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

                data.transactions.forEach(function (trans) {
                    const typeClass = trans.type === 0 ? 'success' : 'danger';
                    const typeSign = trans.type === 0 ? '+' : '-';

                    htmlContent += `
                    <tr>
                        <td>${formatDate(trans.time)}</td>
                        <td><span class="label label-${typeClass}">${trans.typeName}</span></td>
                        <td class="text-right text-${typeClass}">${typeSign}${formatMoney(trans.amount)}</td>
                        <td>${trans.note || ''}</td>
                    </tr>
                `;
                });

                htmlContent += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            }

            console.log('=== Setting HTML content...');
            $('#contractContent').html(htmlContent);
            console.log('=== HTML content set successfully');

        } catch (error) {
            console.log('=== Error in updateContractFinancialDisplay:', error);
            $('#contractContent').html(
                '<div class="alert alert-danger">' +
                '<i class="fa fa-exclamation-triangle"></i> ' +
                'Lỗi hiển thị dữ liệu: ' + error.message +
                '</div>'
            );
        }
    }

    // Utility functions - đảm bảo có sẵn
    function formatMoney(amount) {
        try {
            return new Intl.NumberFormat('vi-VN').format(amount || 0) + ' VNĐ';
        } catch (e) {
            return (amount || 0).toLocaleString() + ' VNĐ';
        }
    }

    function formatDate(dateString) {
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN') + ' ' + date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
        } catch (e) {
            return dateString;
        }
    }

// Cập nhật chi tiết từng khoản chi
function updateChiTietKhoanChi(type, duKien, daChi) {
    const conLai = duKien - daChi;
    const percent = duKien > 0 ? Math.round((daChi / duKien) * 100) : 0;

    $('#dk' + type).text(formatMoney(duKien));
    $('#daChi' + type).text(formatMoney(daChi));
    $('#conLai' + type).text(formatMoney(conLai));
    $('#progress' + type).css('width', percent + '%').attr('title', percent + '%');

    // Thay đổi màu progress bar theo tiến độ
    const progressBar = $('#progress' + type);
    progressBar.removeClass('progress-bar-danger progress-bar-warning progress-bar-success');

    if (percent >= 100) {
        progressBar.addClass('progress-bar-success');
    } else if (percent >= 70) {
        progressBar.addClass('progress-bar-warning');
    } else if (percent >= 50) {
        progressBar.addClass('progress-bar-info');
    }
}

// Cập nhật bảng giao dịch gần nhất
function updateRecentTransactions(transactions) {
    const tbody = $('#recentTransactions');
    tbody.empty();

    if (transactions && transactions.length > 0) {
        transactions.forEach(function(trans) {
            const typeClass = trans.type === 0 ? 'success' : 'danger';
            const typeIcon = trans.type === 0 ? 'arrow-down' : 'arrow-up';
            const typeSign = trans.type === 0 ? '+' : '-';

            const statusClass = trans.status === 0 ? 'warning' :
                              trans.status === 1 ? 'info' : 'success';

            const row = `
                <tr>
                    <td>${formatDate(trans.time)}</td>
                    <td>
                        <span class="label label-${typeClass}">
                            <i class="fa fa-${typeIcon}"></i> ${trans.typeName}
                        </span>
                    </td>
                    <td class="text-right text-${typeClass}">
                        ${typeSign}${formatMoney(trans.amount)}
                    </td>
                    <td>${trans.categoryName}</td>
                    <td>
                        <span class="label label-${statusClass}">${trans.statusName}</span>
                    </td>
                </tr>
            `;
            tbody.append(row);
        });
    } else {
        tbody.html('<tr><td colspan="5" class="text-center text-muted">Chưa có giao dịch</td></tr>');
    }
}

// Utility functions
function formatMoney(amount) {
    return new Intl.NumberFormat('vi-VN').format(amount || 0) + ' VNĐ';
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('vi-VN') + ' ' + date.toLocaleTimeString('vi-VN', {hour: '2-digit', minute:'2-digit'});
}
// Thay thế phần loadCategoriesByContract trong script

// Load categories theo hợp đồng - FIX LỖI
function loadCategoriesByContract(contractId) {
    // Sử dụng parent_id thay vì contract_id
    var parentId = @((int)XCategory.eParent.KhachHang); // Hoặc giá trị parent_id phù hợp

    $.ajax({
        url: '/Categories/FillCategoryContract',
        type: "GET",
        dataType: "JSON",
        data: {
            type: @((int)XCategory.eType.Chi),
            parent_id: parentId  // Sửa từ contract_id thành parent_id
        },
        success: function (categories) {
            $('#chiCategoryId').html('<option value="">-- Chọn loại chi --</option>');
            $.each(categories, function (i, cate) {
                var bgColor = cate.duyet == 0 ? 'style="background-color:#d4edda;"' : '';
                $('#chiCategoryId').append($('<option ' + bgColor + '></option>').val(cate.id).html(cate.name));
            });
        },
        error: function(xhr, status, error) {
            console.log('Error loading categories:', error);
            $('#chiCategoryId').html('<option value="">Lỗi tải dữ liệu</option>');
        }
    });
}

// Cập nhật toàn bộ phần load categories
function loadCategories(type, targetId, parentId) {
    $(targetId).html('<option value="">Đang tải...</option>').prop('disabled', true);

    $.ajax({
        url: '/Categories/FillCategoryContract',
        type: "GET",
        dataType: "JSON",
        data: {
            type: type,
            parent_id: parentId
        },
        success: function (categories) {
            $(targetId).html('<option value="">-- Chọn loại --</option>');
            $.each(categories, function (i, cate) {
                var bgColor = cate.duyet == 0 ? 'style="background-color:#d4edda;"' : '';
                $(targetId).append($('<option ' + bgColor + '></option>').val(cate.id).html(cate.name));
            });
        },
        error: function(xhr, status, error) {
            console.log('Error loading categories:', error);
            $(targetId).html('<option value="">Lỗi tải dữ liệu</option>');
        },
        complete: function() {
            $(targetId).prop('disabled', false);
        }
    });
}
    $(document).ready(function () {
        // Test function để kiểm tra
        window.testContractLoad = function (contractId) {
            console.log('Testing contract load for ID:', contractId);

            $.ajax({
                url: '/InOuts/GetContractFinancialInfo',
                type: 'GET',
                data: { contractId: contractId },
                dataType: 'json',
                success: function (response) {
                    console.log('Test Response:', response);
                },
                error: function (xhr, status, error) {
                    console.log('Test Error:', status, error);
                    console.log('Response Text:', xhr.responseText);
                }
            });
        };

        // Có thể test bằng cách gọi: testContractLoad(1) trong console
    });
    </script>
}