@model PagedList.IPagedList<NiceHandles.Models.vInOut>
@using PagedList.Mvc;
@using NiceHandles.Models
@using Microsoft.AspNet.Identity;
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewBag.Title = "Thu chi";
    var db = new NHModel();
    var types = new SelectList(XCategory.sType, "Key", "Value");
    var username = User.Identity.GetUserName();
    var us = db.Accounts.Where(x => x.UserName.Equals(username)).Single();
    ViewBag.ACCOUNTS = Common.cAccounts();
}
<h2>
    Quản lý thu chi
</h2>

<div class="row">
    <div class="col-md-6">
        <div class="row">
            <div class="col-md-12">
                @Html.Partial("CreateX", new InOut() { time = DateTime.Now, account_id = us.id })
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div id="chartContainer" style="height: 250px; width: 100%;"></div>
    </div>
</div>


@using (Html.BeginForm("IndexX", "InOuts", FormMethod.Get))
{
    <div class="row">

        <div class="col-sm-1">
            <div class="form-group">
                @Html.TextBox("fromdate", ViewBag.FROMDATE as string, new { @class = "form-control datetime", placeholder = "Từ ngày", autocomplete = "off" })
            </div>
        </div>
        <div class="col-sm-1">
            <div class="form-group">
                @Html.TextBox("todate", ViewBag.TODATE as string, new { @class = "form-control datetime", placeholder = "Đến ngày", autocomplete = "off" })
            </div>
        </div>

        <div class="col-sm-1">
            <div class="form-group">
                @Html.TextBox("Search_Data", ViewBag.FilterValue as string, new { @class = "form-control", placeholder = "Tìm kiếm" })
            </div>
        </div>
        <div class="col-sm-1">
            <div class="form-group">
                @Html.DropDownList("s_account_id", new SelectList(ViewBag.ACCOUNTS, "id", "fullname"), "Tài khoản", new { @class = "form-control" })
            </div>
        </div>
        <div class="col-sm-1">
            <div class="form-group">
                @Html.DropDownList("s_type", XCategory.sType.Select(x => new SelectListItem { Value = x.Key.ToString(), Text = x.Value }), "Loại", new { @class = "form-control", @onchange = "s_FillCategory()" })
            </div>
        </div>
        <div class="col-sm-1">
            <div class="form-group">
                @Html.DropDownList("s_category_id", new SelectListItem[0], "Loại chi tiết", new { @class = "form-control" })
            </div>
        </div>
        <div class="col-sm-1">
            <div class="form-group">
                @Html.DropDownList("s_currency", new SelectList(XModels.sLoaiTien, "Key", "Value"), "TM/CK", new { @class = "form-control" })
            </div>
        </div>
        <div class="col-sm-2">
            <div class="form-group">
                <button type="submit" class="btn btn-primary" style="height: 32px; width: 100px;"><i class="fa fa-search"></i> Tìm kiếm</button>
                <button type="button" style="margin-right: 10px;" class="btn btn-default" onclick="Print();"><i class="fa fa-print"></i> Bản in</button>
            </div>
        </div>
        <div class="col-sm-2">
            <div class="form-group">
                @Html.ActionLink("Chuyển thủ quỹ", "GoStock", "InOuts", null, new { style = "margin-right: 10px;", @class = "btn btn-info" })
                @Html.ActionLink("Chốt sổ", "Index", "chotsoes", null, new { @class = "btn btn-info" })
            </div>
        </div>

    </div>
}
<div style="border-radius: 10px; background-color: aliceblue; padding: 15px;" class="row">
    <div class="col-sm-2">Tổng thu: <b> @ViewBag.TONGTHU </b></div>
    <div class="col-sm-2 text-danger">Tổng chi: <b>@ViewBag.TONGCHI </b></div>
    <div class="col-sm-2">Thu - Chi: <b>@ViewBag.THUCHI </b></div>
    <div class="col-sm-2 text-success">Ngân hàng: <b>@ViewBag.NGANHANG </b></div>
    <div class="col-sm-2 text-primary">Tiền mặt: <b>@ViewBag.TIENMAT </b></div>
</div>
<table class="table table-hover">
    <thead>
        <tr>
            <th>
                Thời gian
            </th>
            <th>
                Hợp đồng
            </th>
            <th>
                Người thực hiện
            </th>
            <th>
                Loại
            </th>
            <th>
                Loại chi tiết
            </th>
            <th>
                Loại tiền
            </th>
            <th>
                Số tiền
            </th>
            <th>
                Ghi chú
            </th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        @for (int i = 0; i < Model.Count; i++)
        {
            string contract_name = string.Empty;
            if (Model[i].contract_id.HasValue)
            {
                var contract = db.Contracts.Find(Model[i].contract_id.Value);
                var customer = db.Customers.Find(contract.customer_id);
                contract_name = customer.name;
            }

            <tr class="@(Model[i].type==(int)XCategory.eType.Chi ? "text-danger" : null )">
                <td>@Model[i].time.ToString("dd/MM/yyyy")</td>
                <td>@contract_name</td>
                <td>@Html.ActionLink(Model[i].fullname, "Details", new { id = Model[i].id }) </td>
                <td>@Html.ActionLink(XCategory.sType[Model[i].type], "Details", new { id = Model[i].id }) </td>
                <td>@Html.Raw(Model[i].name)</td>
                <td>@XModels.sLoaiTien[Model[i].currency]</td>
                <td>@((Model[i].type==(int)XCategory.eType.Chi ? "-" : null) + Model[i].amount.ToString("N0"))</td>
                <td>@Model[i].note</td>
                <td style="@(!Model[i].state.HasValue ? "" : "display:none")">
                    @Html.ActionLink("Sửa", "Edit", new { id = Model[i].id }) |
                    @Html.ActionLink("Xóa", "Delete", new { id = Model[i].id }, new { @class = "del" })
                </td>
            </tr>
        }
    </tbody>
</table>
@if (Model.PageCount > 1)
{
    <div class="row" style="margin-top: 10px;">
        <div class="col-sm-1">
            Trang @(Model.PageCount < Model.PageNumber ? 0 : Model.PageNumber) / @Model.PageCount
        </div>
        <div class="col-sm-10">
            @Html.PagedListPager(Model, Page_No => Url.Action("Index", new { Page_No, Filter_Value = ViewBag.FilterValue, account_id = ViewBag.account_id, category_id = ViewBag.category_id, type = ViewBag.type, fromdate = ViewBag.FROMDATE, todate = ViewBag.TODATE }))
        </div>
    </div>
}
<div id="password" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" style="float: left;">Nhập mật khẩu xóa</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Để chắc chắn rằng mình muốn xóa, vui lòng nhập mật khẩu</p>
                <input type="password" class="form-control" id="txtPassword" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="confirmed()">Chấp nhận</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<iframe id="my_iframe" style="display:none;"></iframe>
@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    <script src="https://cdn.canvasjs.com/canvasjs.min.js"></script>
    <script>
        var currentDelCtr = null;
        $(document).ready(function () {
            $(".datetime").datepicker({
                "autoclose": true,
                "todayHighlight": true,
                "dateFormat": "dd/mm/yyyy",
                "format": "dd/mm/yyyy",
            }).datepicker();

            $(".del").click(function () {
                currentDelCtr = this;
                $("#password").modal("show");
                return false;
            });
            $('#password').on('hidden.bs.modal', function () {
                currentDelCtr.click();
            });
            var dataPoints = @ViewBag.CHART;
            var chart = new CanvasJS.Chart("chartContainer", {
                animationEnabled: true,
                title: {
                    /*text: "17%",*/
                    horizontalAlign: "center",
                },
                data: [{
                    type: "doughnut",
                    startAngle: 50,
                    innerRadius: 50,
                    indexLabelFontSize: 17,
                    indexLabel: "{label} - #percent%",
                    toolTipContent: "<b>{label}:</b> {y} (#percent%)",
                    dataPoints: dataPoints
                }]
            });
            chart.render();
        });
        function confirmed() {
            var pass = $("#txtPassword").val();
            if (pass == "@Html.Raw(NiceHandles.Models.XModels.Password)") {
                $(currentDelCtr).removeClass("del");
                $(currentDelCtr).off("click");
                $("#password").modal("hide");
            }
        }
        function FillCategory() {
            var cate = $('#type').val();
            if (!cate || cate == "") {
                $("#category_id").html($('<option></option>').val("").html("Loại chi tiết"));
            }
            else {
                $.ajax({
                    url: '/Categories/FillCategory',
                    type: "GET",
                    dataType: "JSON",
                    data: { cate: cate },
                    success: function (categories) {
                        $("#category_id").html(""); // clear before appending new list
                        $("#category_id").append(
                            $('<option></option>').val("").html("Loại chi tiết"));
                        $.each(categories, function (i, cate) {
                            $("#category_id").append(
                                $('<option></option>').val(cate.id).html(cate.name));
                        });
                    }
                });
            }
        }
        function s_FillCategory() {
            var cate = $('#s_type').val();
            if (!cate || cate == "") {
                $("#s_category_id").html($('<option></option>').val("").html("Loại chi tiết"));
            }
            else {
                $.ajax({
                    url: '/Categories/FillCategory',
                    type: "GET",
                    dataType: "JSON",
                    data: { cate: cate },
                    success: function (categories) {
                        $("#s_category_id").html(""); // clear before appending new list
                        $("#s_category_id").append(
                            $('<option></option>').val("").html("Loại chi tiết"));
                        $.each(categories, function (i, cate) {
                            $("#s_category_id").append(
                                $('<option></option>').val(cate.id).html(cate.name));
                        });
                    }
                });
            }
        }
        function Print() {
            var Search_Data = $("#Search_Data").val();
            var account_id = $("#account_id").val();
            var type = $("#type").val();
            var category_id = $("#category_id").val();
            var fromdate = $("#fromdate").val();
            var todate = $("#todate").val();

            $.ajax({
                url: '/Inouts/BanInThuChi',
                data: {
                    Search_Data: Search_Data,
                    account_id: account_id,
                    type: type,
                    category_id: category_id,
                    fromdate: fromdate,
                    todate: todate
                },
                type: "GET",
                dataType: "JSON",
                success: function (url) {
                    document.getElementById('my_iframe').src = url;
                }
            });
        }
    </script>
}
