@model PagedList.IPagedList<NiceHandles.Models.Dove_ThuChi>
@using PagedList.Mvc;
@using NiceHandles.Models
@using Microsoft.AspNet.Identity;
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewBag.Title = "Thu chi";
    var db = new NHModel();
    var types = new SelectList(XCategory.sType, "Key", "Value");
    var username = User.Identity.GetUserName();
    var us = db.Accounts.Where(x => x.UserName.Equals(username)).Single();
    var lstAccount = db.Accounts.Select(x => new { id = x.id, disname = x.disname }).ToList();
    ViewBag.ACCOUNTS = db.Accounts.Where(x => x.sta == (int)XAccount.eStatus.Processing);
}
<h2>
    Quản lý thu chi
</h2>

<div class="row">
    <div class="col-md-12">
        @Html.Partial("CreateX", new InOut() { time = DateTime.Now, account_id = us.id })
    </div>
</div>

@using (Html.BeginForm("Index", "Dove_ThuChi", FormMethod.Get))
{
    <div class="row">

        <div class="col-sm-1">
            <div class="form-group">
                @Html.TextBox("fromdate", ViewBag.FROMDATE as string, new { @class = "form-control datetime", placeholder = "Từ ngày", autocomplete = "off" })
            </div>
        </div>
        <div class="col-sm-1">
            <div class="form-group">
                @Html.TextBox("todate", ViewBag.TODATE as string, new { @class = "form-control datetime", placeholder = "Đến ngày", autocomplete = "off" })
            </div>
        </div>
        <div class="col-sm-1">
            <div class="form-group">
                @Html.DropDownList("s_account_id", new SelectList(ViewBag.ACCOUNTS, "id", "fullname"), "Tài khoản", new { @class = "form-control" })
            </div>
        </div>
        <div class="col-sm-1">
            <div class="form-group">
                @Html.DropDownList("s_type", XCategory.sType.Select(x => new SelectListItem { Value = x.Key.ToString(), Text = x.Value }), "Loại", new { @class = "form-control", @onchange = "s_FillCategory()" })
            </div>
        </div>
        <div class="col-sm-3">
            <div class="form-group">
                @Html.DropDownList("s_contract_id", new SelectList(new Contract[] { }, "contract_id", "name"), "Chọn hợp đồng", new { @class = "form-control" })
            </div>
        </div>
        <div class="col-sm-1">
            <div class="form-group">
                @Html.TextBox("Search_Data", ViewBag.FilterValue as string, new { @class = "form-control", placeholder = "Tìm kiếm" })
            </div>
        </div>
        <div class="col-sm-2">
            <div class="form-group">
                <button type="submit" class="btn btn-primary" style="height: 32px; width: 100px;"><i class="fa fa-search"></i> Tìm kiếm</button>
                <button type="button" style="margin-right: 10px;" class="btn btn-default" onclick="Print();"><i class="fa fa-print"></i> Bản in</button>
            </div>
        </div>
    </div>
}
<div style="border-radius: 10px; background-color: aliceblue; padding: 15px;" class="row">
    <div class="col-sm-2">Tổng thu: <b> @ViewBag.TONGTHU </b></div>
    <div class="col-sm-2 text-danger">Tổng chi: <b>@ViewBag.TONGCHI </b></div>
    <div class="col-sm-2">Thu - Chi: <b>@ViewBag.THUCHI </b></div>
</div>
<table class="table table-hover">
    <thead>
        <tr>
            <th>
                Thời gian
            </th>
            <th>
                Hợp đồng
            </th>
            <th>
                Người thực hiện
            </th>
            <th>
                Người nhận
            </th>
            <th>
                Loại
            </th>
            <th>
                Số tiền
            </th>
            <th>
                Ghi chú
            </th>
        </tr>
    </thead>
    <tbody>
        @for (int i = 0; i < Model.Count; i++)
        {
            string contract_name = string.Empty;
            if (Model[i].contract_id.HasValue)
            {
                var contract = db.Contracts.Find(Model[i].contract_id.Value);
                contract_name = contract.name;
            }

            <tr class="@(Model[i].type==(int)XCategory.eType.Chi ? "text-danger" : null )">
                <td>@Model[i].time.ToString("dd/MM/yyyy")</td>
                <td>@contract_name</td>
                <td>@Html.Raw(lstAccount.Find(x => x.id == Model[i].created_by).disname) </td>
                <td>@Html.Raw(lstAccount.Find(x => x.id == Model[i].account_id).disname) </td>
                <td>@Html.Raw(XCategory.sType[Model[i].type]) </td>
                <td style="text-align: right;">@((Model[i].type==(int)XCategory.eType.Chi ? "-" : null) + Model[i].amount.ToString("N0"))</td>
                <td>@Model[i].note</td>
            </tr>
        }
    </tbody>
</table>
@if (Model.PageCount > 1)
{
    <div class="row" style="margin-top: 10px;">
        <div class="col-sm-1">
            Trang @(Model.PageCount < Model.PageNumber ? 0 : Model.PageNumber) / @Model.PageCount
        </div>
        <div class="col-sm-10">
            @Html.PagedListPager(Model, Page_No => Url.Action("Index", new { Page_No, Filter_Value = ViewBag.FilterValue, s_account_id = ViewBag.account_id, s_contract_id = ViewBag.contract_id, s_type = ViewBag.type, fromdate = ViewBag.FROMDATE, todate = ViewBag.TODATE }))
        </div>
    </div>
}
<iframe id="my_iframe" style="display:none;"></iframe>
@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    <script>
        var currentDelCtr = null;
        $(document).ready(function () {
            $(".datetime").datepicker({
                "autoclose": true,
                "todayHighlight": true,
                "dateFormat": "dd/mm/yyyy",
                "format": "dd/mm/yyyy",
            }).datepicker();
            SetSelect2("#contract_id", "/Jobs/GetContract", "VD: Nguyễn Văn A");
            SetSelect2("#s_contract_id", "/Jobs/GetContract", "VD: Nguyễn Văn A");
            $("#msk_amount").blur(function () {
                var amount = $("#msk_amount").val();
                if (!amount || amount == "0") {
                    $("#btnShow").attr("disabled", true);
                }
                else {
                    $("#btnShow").attr("disabled", false);
                }
            });
        });
        function FillCategory() {
            var cate = $('#type').val();
            if (!cate || cate == "") {
                $("#category_id").html($('<option></option>').val("").html("Loại chi tiết"));
            }
            else {
                $.ajax({
                    url: '/Categories/FillCategory',
                    type: "GET",
                    dataType: "JSON",
                    data: { cate: cate },
                    success: function (categories) {
                        $("#category_id").html(""); // clear before appending new list
                        $("#category_id").append(
                            $('<option></option>').val("").html("Loại chi tiết"));
                        $.each(categories, function (i, cate) {
                            $("#category_id").append(
                                $('<option style="' + (cate.duyet == 0 ?'background-color:antiquewhite;' : '' ) +'"></option>').val(cate.id).html(cate.name));
                        });
                    }
                });
            }
        }
        function FillCategoryX(cate, p, taget) {
            $.ajax({
                url: '/Categories/FillCategoryContract',
                type: "GET",
                dataType: "JSON",
                data: { type: cate, parent_id:p },
                success: function (categories) {
                    $(taget).html(""); // clear before appending new list
                    $(taget).append(
                        $('<option></option>').val("").html("Loại chi tiết"));
                    $.each(categories, function (i, cate) {
                        $(taget).append(
                            $('<option style="' + (cate.duyet == 0 ? 'background-color:antiquewhite;' : '') + '"></option>').val(cate.id).html(cate.name));
                    });
                }
            });
        }
        function s_FillCategory() {
            var cate = $('#s_type').val();
            if (!cate || cate == "") {
                $("#s_category_id").html($('<option></option>').val("").html("Loại chi tiết"));
            }
            else {
                $.ajax({
                    url: '/Categories/FillCategory',
                    type: "GET",
                    dataType: "JSON",
                    data: { cate: cate },
                    success: function (categories) {
                        $("#s_category_id").html(""); // clear before appending new list
                        $("#s_category_id").append(
                            $('<option></option>').val("").html("Loại chi tiết"));
                        $.each(categories, function (i, cate) {
                            $("#s_category_id").append(
                                $('<option></option>').val(cate.id).html(cate.name));
                        });
                    }
                });
            }
        }
        function Print() {
            var Search_Data = $("#Search_Data").val();
            var account_id = $("#s_account_id").val();
            var type = $("#s_type").val();
            var fromdate = $("#fromdate").val();
            var todate = $("#todate").val();

            $.ajax({
                url: '/Dove_ThuChi/BanInThuChi',
                data: {
                    Search_Data: Search_Data,
                    account_id: account_id,
                    type: type,
                    fromdate: fromdate,
                    todate: todate
                },
                type: "GET",
                dataType: "JSON",
                success: function (url) {
                    document.getElementById('my_iframe').src = url;
                }
            });
        }
         function TypeChange() {
             var inout = $("#inout").val();
            if (inout == @((int)XCategory.eParent.VanPhong)) {
                $("#contract_id").val("").trigger("change");
                $("#contract_id").prop("disabled", true)
            } else {
                $("#contract_id").prop("disabled", false)
             }
        }
        function btnSubmitCreateInout() {
            var inout = $("#inout").val();
             if (inout == @((int)XCategory.eParent.VanPhong)) {
                 $("#contract_id").val("");
             } else {
                 var contract_id = $("#contract_id").val();
                 if (!contract_id || contract_id == "") {
                     $(".validContract_id").removeClass("hide");
                     return false;
                 }
            }
            $("#amount").val($("#msk_amount").autoNumeric('get') || 0);
            $("#btnSubmit").click();
        }
        function formatRepo(repo) {
            if (repo.loading) {
                return repo.text;
            }

            var $container = $(
                "<div class='select2-result-repository clearfix'>" +
                "   <div class='select2-result-repository-meta'>" +
                "       <div class='select2-result-repository-title' style='font-weight: bold;'></div>" +
                "       <div class='select2-result-repository-description'></div>" +
                "   </div>" +
                "</div>"
            );

            $container.find(".select2-result-repository-title").text(repo.name);
            $container.find(".select2-result-repository-description").text(repo.text);

            return $container;
        }

        function formatRepoSelection(repo) {
            return repo.name || repo.text;
        }
    </script>
}
