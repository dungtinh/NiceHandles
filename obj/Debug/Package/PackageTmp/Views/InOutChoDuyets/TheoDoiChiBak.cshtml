@model PagedList.IPagedList<NiceHandles.Models.vTheoDoiChi>
@using PagedList.Mvc;
@using NiceHandles.Models
@{
    var db = new NHModel();
}

<h3> DANH SÁCH CÁC KHOẢN CHI ĐI THỰC HIỆN</h3>
@using (Html.BeginForm("TheoDoiChi", "InOutChoDuyets", FormMethod.Get))
{
    <div class="row">
        <div class="col-sm-1">
            <div class="form-group">
                @Html.TextBox("fromdate", ViewBag.FROMDATE as string, new { @class = "form-control datetime", placeholder = "Từ ngày", autocomplete = "off" })
            </div>
        </div>
        <div class="col-sm-1">
            <div class="form-group">
                @Html.TextBox("todate", ViewBag.TODATE as string, new { @class = "form-control datetime", placeholder = "Đến ngày", autocomplete = "off" })
            </div>
        </div>
        <div class="col-sm-1">
            <div class="form-group">
                @Html.DropDownList("account_id", new SelectList(db.Accounts.Where(x => x.sta == (int)XAccount.eStatus.Processing), "id", "fullname"), "Tài khoản", new { @class = "form-control" })
            </div>
        </div>
        <div class="col-sm-1">
            <div class="form-group">
                @Html.DropDownList("status", new SelectList(XDuChiNhatKy.sStatus, "Key", "Value"), "Trạng thái", new { @class = "form-control" })
            </div>
        </div>
        <div class="col-sm-2">
            <div class="form-group">
                @Html.DropDownList("contract_id", new SelectList(new Contract[] { }, "contract_id", "name"), "Chọn hợp đồng", new { @class = "form-control" })
            </div>
        </div>
        <div class="col-sm-1">
            <div class="form-group">
                @Html.TextBox("Search_Data", ViewBag.FilterValue as string, new { @class = "form-control", placeholder = "Tìm kiếm" })
            </div>
        </div>
        <div class="col-sm-2">
            <div class="form-group">
                <button type="submit" class="btn btn-primary" style="height: 32px; width: 100px;"><i class="fa fa-search"></i> Tìm kiếm</button>
                <button type="button" style="margin-left: 15px;" class="btn btn-default" onclick="Print();"><i class="fa fa-print"></i> Bản in</button>
            </div>
        </div>
    </div>
}
<div style="border-radius: 10px; background-color: aliceblue; padding: 15px;" class="row">
    <div class="col-sm-2">Tổng: <b> @ViewBag.TONG </b></div>
    <div class="col-sm-2 text-primary">Lương đang giữ: <b>@ViewBag.SumLuongGiu </b></div>
    <div class="col-sm-2 text-danger">Chờ thực hiện: <b>@ViewBag.SumChoThuHien </b></div>
    <div class="col-sm-2 text-primary">Đã thực hiện: <b>@ViewBag.SumDaThucHien </b></div>
    <div class="col-sm-2 text-muted">Tiền trả lại: <b>@ViewBag.SumTraLai </b></div>
</div>
<hr />
<div class="row" id="duyetchi">
    <table class="table table-hover">
        <thead>
            <tr>
                <th>
                    Hợp đồng
                </th>
                <th>
                    Địa chỉ
                </th>
                <th>
                    Dịch vụ
                </th>
                <th>
                    Người lĩnh/TH
                </th>
                <th>
                    Loại chi tiết
                </th>
                <th>
                    Số tiền
                </th>
                <th>
                    Tiến độ
                </th>
                <th>
                    Ghi chú
                </th>
                <th>
                    Trả lại
                </th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr>
                    <td style="line-height: 30px;">
                        @item.contract_name
                    </td>
                    <td style="line-height: 30px;">
                        @item.address_name
                    </td>
                    <td style="line-height: 30px;">
                        @item.service_name
                    </td>
                    <td style="line-height: 30px;">
                        @item.fullname
                    </td>
                    <td style="line-height: 30px;">
                        @item.category_name
                    </td>
                    <td style="line-height: 30px;">
                        @item.amount.ToString("N0")
                    </td>
                    <td>
                        @if (item.status < (int)XDuChiNhatKy.eStatus.DaDi)
                        {
                            <button class="btn btn-info" type="button" onclick="ConfirmDialog(@item.inout_id, @(item.status + 1), null,'Xác nhận thực hiện');"> @XDuChiNhatKy.sStatus[item.status]</button>
                        }
                        else
                        {
                            @XDuChiNhatKy.sStatus[item.status]
                        }
                    </td>
                    <td>
                        <input type="text" value="@item.note" class="form-control" onchange="ConfirmDialog(@item.inout_id, null, this.value,'Xác nhận thực hiện');" />
                    </td>
                    <td>
                        <button class="btn btn-danger" type="button" onclick="ConfirmTraLai(@item.inout_id,'Xác nhận thực hiện');">@XDuChiNhatKy.sStatus[(int)XDuChiNhatKy.eStatus.TraLai]</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
    @if (Model.PageCount > 1)
    {
        <div class="row" style="margin-top: 10px;">
            <div class="col-sm-1">
                Trang @(Model.PageCount < Model.PageNumber ? 0 : Model.PageNumber) / @Model.PageCount
            </div>
            <div class="col-sm-10">
                @Html.PagedListPager(Model, Page_No => Url.Action("TheoDoiChi", new { Page_No, Filter_Value = ViewBag.FilterValue, account_id = ViewBag.account_id, category_id = ViewBag.category_id, contract_id = ViewBag.contract_id, status = ViewBag.status, fromdate = ViewBag.FROMDATE, todate = ViewBag.TODATE }))
            </div>
        </div>
    }
</div>
<iframe id="my_iframe" style="display:none;"></iframe>
<style>
    .select2 .selection .select2-selection {
        height: 34px;
    }
</style>
@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    <link href="~/Content/jquery-confirm.min.css" rel="stylesheet" />
    <script src="~/Scripts/jquery-confirm.min.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            SetSelect2("#contract_id", "/Jobs/GetContract", "VD: Nguyễn Văn A");
        });
        function DiThucHien(id, status, note) {
            $.ajax({
                url: '/DuChis/DiThucHien',
                data: {
                    id: id,
                    status: status,
                    note: note
                },
                type: "POST",
                dataType: "JSON",
                success: function (nhatky) {
                    if (note) {
                        toastr.success("Đã lưu thành công", "Ghi chú thực hiện", { timeOut: 5000 });
                    } else {
                        document.location.reload();
                    }
                }
            });
        }
        function TraLaiDuChi(id) {
            $.ajax({
                url: '/DuChis/TraLaiDuChi',
                data: {
                    id: id
                },
                type: "POST",
                dataType: "JSON",
                success: function (obj) {
                    document.location.reload();
                }
            });
        }
        function Print() {
            var Search_Data = $("#Search_Data").val();
            var account_id = $("#account_id").val();
            var status = $("#status").val();
            var contract_id = $("#contract_id").val();
            var fromdate = $("#fromdate").val();
            var todate = $("#todate").val();

            $.ajax({
                url: '/InoutChoDuyets/BanInTheoDoiChi',
                data: {
                    Search_Data: Search_Data,
                    account_id: account_id,
                    status: status,
                    contract_id: contract_id,
                    fromdate: fromdate,
                    todate: todate
                },
                type: "GET",
                dataType: "JSON",
                success: function (url) {
                    document.getElementById('my_iframe').src = url;
                }
            });
        }
        function ConfirmDialog(id, status, note, message) {
            $.confirm({
                title: 'YÊU CẦU',
                content: message,
                buttons: {
                    confirm: {
                        text: 'Đồng ý',
                        action: function () {
                            DiThucHien(id, status, note);
                        }
                    },
                    cancel: function () {
                        // do nothing
                    }
                    //,somethingElse: {
                    //    text: 'Something else',
                    //    btnClass: 'btn-blue',
                    //    keys: ['enter', 'shift'],
                    //    action: function () {
                    //        $.alert('Something else?');
                    //    }
                    //}
                }
            });
        }
        function ConfirmTraLai(id, message) {
            $.confirm({
                title: 'YÊU CẦU',
                content: message,
                buttons: {
                    confirm: {
                        text: 'Đồng ý',
                        action: function () {
                            TraLaiDuChi(id);
                        }
                    },
                    cancel: function () {
                        // do nothing
                    }
                }
            });
        }
    </script>
}
