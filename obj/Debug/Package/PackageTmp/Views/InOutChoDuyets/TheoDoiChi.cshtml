@model PagedList.IPagedList<NiceHandles.Models.vTheoDoiChi>
@using PagedList.Mvc;
@using NiceHandles.Models
@{
    var db = new NHModel();
}

<h3> DANH SÁCH CÁC KHOẢN CHI ĐI THỰC HIỆN</h3>
@using (Html.BeginForm("TheoDoiChi", "InOutChoDuyets", FormMethod.Get))
{
    <div class="row">
        <div class="col-sm-1">
            <div class="form-group">
                @Html.TextBox("fromdate", ViewBag.FROMDATE as string, new { @class = "form-control datetime", placeholder = "Từ ngày", autocomplete = "off" })
            </div>
        </div>
        <div class="col-sm-1">
            <div class="form-group">
                @Html.TextBox("todate", ViewBag.TODATE as string, new { @class = "form-control datetime", placeholder = "Đến ngày", autocomplete = "off" })
            </div>
        </div>
        <div class="col-sm-1">
            <div class="form-group">
                @Html.DropDownList("account_id", new SelectList(db.Accounts.Where(x => x.sta == (int)XAccount.eStatus.Processing), "id", "fullname", ViewBag.account_id), "Tài khoản", new { @class = "form-control" })
            </div>
        </div>
        <div class="col-sm-1">
            <div class="form-group">
                @Html.DropDownList("status", new SelectList(XDuChiNhatKy.sStatus, "Key", "Value", ViewBag.status), "Trạng thái", new { @class = "form-control" })
            </div>
        </div>
        <div class="col-sm-2">
            <div class="form-group">
                @Html.DropDownList("contract_id", new SelectList(new Contract[] { }, "contract_id", "name", ViewBag.contract_id), "Chọn hợp đồng", new { @class = "form-control" })
            </div>
        </div>
        <div class="col-sm-1">
            <div class="form-group">
                @Html.TextBox("Search_Data", ViewBag.FilterValue as string, new { @class = "form-control", placeholder = "Tìm kiếm" })
            </div>
        </div>
        <div class="col-sm-2">
            <div class="form-group">
                @Html.RadioButton("sort", 0, Convert.ToBoolean(ViewBag.SORTSTATUS as string), new { id = "SORTSTATUS", Checked = "checked" })
                <label for="SORTSTATUS">Sắp xếp theo trạng thái</label>
                <br />
                @Html.RadioButton("sort", 1, Convert.ToBoolean(ViewBag.SORTTIME as string), new { id = "SORTTIME" })
                <label for="SORTTIME">Sắp xếp theo thời gian</label>
                <br />
                @Html.RadioButton("sort", 2, Convert.ToBoolean(ViewBag.SORTNAME as string), new { id = "SORTNAME" })
                <label for="SORTNAME">Sắp xếp theo tên</label>
            </div>
        </div>
        <div class="col-sm-2">
            <div class="form-group">
                <button type="submit" class="btn btn-primary" style="height: 32px; width: 100px;"><i class="fa fa-search"></i> Tìm kiếm</button>
                <button type="button" style="margin-left: 15px;" class="btn btn-default" onclick="Print();"><i class="fa fa-print"></i> Bản in</button>
            </div>
        </div>
    </div>
}
<div style="border-radius: 10px; background-color: aliceblue; padding: 15px;" class="row">
    <div class="col-sm-2">Tổng: <b> @ViewBag.TONG </b></div>
    <div class="col-sm-2 text-primary">Lương đang giữ: <b>@ViewBag.SumLuongGiu </b></div>
    <div class="col-sm-2 text-danger">Chờ thực hiện: <b>@ViewBag.SumChoThuHien </b></div>
    <div class="col-sm-2 text-primary">Đã thực hiện: <b>@ViewBag.SumDaThucHien </b></div>
    <div class="col-sm-2 text-muted">Tiền trả lại: <b>@ViewBag.SumTraLai </b></div>
</div>
<hr />
<div class="row" id="duyetchi">
    <table class="table table-hover">
        <thead>
            <tr>
                <th>
                    Hợp đồng
                </th>
                <th>
                    Địa chỉ
                </th>
                <th>
                    Dịch vụ
                </th>
                <th>
                    Người lĩnh/TH
                </th>
                <th>
                    Loại chi tiết
                </th>
                <th>
                    Số tiền
                </th>
                <th>
                    Ghi chú
                </th>
                <th>
                    Trạng thái
                </th>
                <th>
                    Tác vụ
                </th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr>
                    <td style="line-height: 30px;">
                        @item.contract_name
                    </td>
                    <td style="line-height: 30px;">
                        @item.address_name
                    </td>
                    <td style="line-height: 30px;">
                        @item.service_name
                    </td>
                    <td style="line-height: 30px;">
                        @item.fullname
                    </td>
                    <td style="line-height: 30px;">
                        @item.category_name
                    </td>
                    <td style="line-height: 30px;">
                        @item.amount.ToString("N0")
                    </td>
                    <td>
                        <input type="text" value="@item.note" class="form-control" onchange="ConfirmDialogMessage(@item.inout_id, this.value,'Xác nhận thực hiện');" />
                    </td>
                    <td>
                        @XDuChiNhatKy.sStatus[item.status]
                    </td>
                    <td>
                        @if (item.status == (int)XDuChiNhatKy.eStatus.LuongGiu)
                        {
                            <button class="btn btn-info" type="button" onclick="OCShowChuyenThucHien(@item.inout_id, @Html.Raw("'" +item.category_name + "/" + item.contract_name + "'"))"> Chuyển thực hiện</button>
                            <button class="btn btn-danger" type="button" onclick="ConfirmTraLai(@item.inout_id,'Xác nhận thực hiện hủy thu chi (Phần mềm sẽ tự thêm mới khoản thu tương ứng vào hợp đồng)');">Hủy</button>
                        }
                        else if (item.status == (int)XDuChiNhatKy.eStatus.DiThucHien)
                        {
                            <button class="btn btn-success" type="button" onclick="ConfirmDialog(@item.inout_id, 'Xác nhận đi thực hiện');"> Đi thực hiện</button>
                            <button class="btn btn-warning" type="button" onclick="ConfirmDialogTraLai(@item.inout_id, 'Trả lại quỹ dự chi chờ thực hiện sau hoặc hủy');"> Trả quỹ</button>
                        }
                        <button class="btn btn-default" type="button" onclick="ViewHistory(@item.id);">Xem LS</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
    @if (Model.PageCount > 1)
    {
        <div class="row" style="margin-top: 10px;">
            <div class="col-sm-1">
                Trang @(Model.PageCount < Model.PageNumber ? 0 : Model.PageNumber) / @Model.PageCount
            </div>
            <div class="col-sm-10">
                @Html.PagedListPager(Model, Page_No => Url.Action("TheoDoiChi", new { Page_No, Filter_Value = ViewBag.FilterValue, account_id = ViewBag.account_id, sort = ViewBag.sort, category_id = ViewBag.category_id, contract_id = ViewBag.contract_id, status = ViewBag.status, fromdate = ViewBag.FROMDATE, todate = ViewBag.TODATE }))
            </div>
        </div>
    }
</div>
<div id="mdlChuyenThucHien" class="modal" role="dialog" tabindex="-1">
    <div class="modal-dialog modal-lg" role="document" style="width:80%">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title"></h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="form-horizontal">
                            <input type="hidden" id="cthInoutId" />
                            <div class="form-group">
                                <label class="control-label col-md-2">Người thực hiện</label>
                                <div class="col-md-10">
                                    @Html.DropDownList("cthCboNguoiThucHien",
                                   new SelectList(db.Accounts.Where(x => x.sta == (int)XAccount.eStatus.Processing && x.manager == 1), "id", "fullname"),
                                   "-- Chọn người thực hiện --", new { @class = "form-control" })
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label col-md-2">Mật khẩu</label>
                                <div class="col-md-10">
                                    <input type="password" class="form-control" id="cthTxtPassword" /><br />
                                    <i id="cthTxtPasswordError" class="text-danger hide">Sai mật khẩu</i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="OCChuyenThucHien();">Chuyển thực hiện</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng lại</button>
            </div>
        </div>
    </div>
</div>
<iframe id="my_iframe" style="display:none;"></iframe>
@Html.Partial("../Shared/Modals/_ModalNH")
<style>
    .select2 .selection .select2-selection {
        height: 34px;
    }
</style>
@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    <link href="~/Content/jquery-confirm.min.css" rel="stylesheet" />
    <script src="~/Scripts/jquery-confirm.min.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            SetSelect2("#contract_id", "/Jobs/GetContract", "VD: Nguyễn Văn A");
            if ($('[name="sort"]').is(':checked') == false) { $("#SORTSTATUS").prop('checked', true); }
        });
        function OCShowChuyenThucHien(inout_id, title) {
            $("#cthInoutId").val(inout_id);
            $("#mdlChuyenThucHien .modal-title").text(title);
            $("#mdlChuyenThucHien").modal("show");
        }
        function OCChuyenThucHien() {
            var account_id = $("#cthCboNguoiThucHien").val();
            var password = $("#cthTxtPassword").val();
            var id = $("#cthInoutId").val();
            if (password == "@Html.Raw(NiceHandles.Models.XModels.Password)") {
                $.ajax({
                    url: '/DuChis/ChuyenThucHien',
                    data: {
                        id: id,
                        account_id: account_id
                    },
                    type: "POST",
                    dataType: "JSON",
                    success: function (nhatky) {
                        document.location.reload();
                    }
                });
            } else {
                $("#cthTxtPasswordError").removeClass("hide");
            }
        }
        function DiThucHien(id) {
            $.ajax({
                url: '/DuChis/DiThucHien',
                data: {
                    id: id
                },
                type: "POST",
                dataType: "JSON",
                success: function (nhatky) {
                    document.location.reload();
                }
            });
        }
        function SaveNote(id, note) {
            $.ajax({
                url: '/DuChis/LuuGhiChu',
                data: {
                    id: id,
                    note: note
                },
                type: "POST",
                dataType: "JSON",
                success: function (nhatky) {
                    toastr.success("Đã lưu thành công", "Ghi chú thực hiện", { timeOut: 5000 });
                }
            });
        }
        function TraLai(id) {
            $.ajax({
                url: '/DuChis/HoanTra',
                data: {
                    id: id
                },
                type: "POST",
                dataType: "JSON",
                success: function (nhatky) {
                    document.location.reload();
                }
            });
        }
        function TraLaiDuChi(id) {
            $.ajax({
                url: '/DuChis/TraLaiDuChi',
                data: {
                    id: id
                },
                type: "POST",
                dataType: "JSON",
                success: function (obj) {
                    document.location.reload();
                }
            });
        }
        function ViewHistory(id) {
            $.ajax({
                url: '/DuChis/ViewHistory',
                type: 'GET',
                cache: false,
                data: { id: id }
            }).done(function (result) {
                $("#mdlNH .modal-body").html(result);
                $("#mdlNH").modal("show");
            });
        }

        function Print() {
            var Search_Data = $("#Search_Data").val();
            var account_id = $("#account_id").val();
            var status = $("#status").val();
            var contract_id = $("#contract_id").val();
            var fromdate = $("#fromdate").val();
            var todate = $("#todate").val();

            $.ajax({
                url: '/InoutChoDuyets/BanInTheoDoiChi',
                data: {
                    Search_Data: Search_Data,
                    account_id: account_id,
                    status: status,
                    contract_id: contract_id,
                    fromdate: fromdate,
                    todate: todate
                },
                type: "GET",
                dataType: "JSON",
                success: function (url) {
                    document.getElementById('my_iframe').src = url;
                }
            });
        }
        function ConfirmDialogMessage(id, note, message) {
            $.confirm({
                title: 'YÊU CẦU',
                content: message,
                buttons: {
                    confirm: {
                        text: 'Đồng ý',
                        action: function () {
                            SaveNote(id, note);
                        }
                    },
                    cancel: function () {
                        // do nothing
                    }
                }
            });
        }
        function ConfirmDialog(id, message) {
            $.confirm({
                title: 'YÊU CẦU',
                content: message,
                buttons: {
                    confirm: {
                        text: 'Đồng ý',
                        action: function () {
                            DiThucHien(id);
                        }
                    },
                    cancel: function () {
                        // do nothing
                    }
                    //,somethingElse: {
                    //    text: 'Something else',
                    //    btnClass: 'btn-blue',
                    //    keys: ['enter', 'shift'],
                    //    action: function () {
                    //        $.alert('Something else?');
                    //    }
                    //}
                }
            });
        }
        function ConfirmDialogTraLai(id, message) {
            $.confirm({
                title: 'YÊU CẦU',
                content: message,
                buttons: {
                    confirm: {
                        text: 'Đồng ý',
                        action: function () {
                            TraLai(id);
                        }
                    },
                    cancel: function () {
                        // do nothing
                    }
                }
            });
        }
        function ConfirmTraLai(id, message) {
            $.confirm({
                title: 'YÊU CẦU',
                content: message,
                buttons: {
                    confirm: {
                        text: 'Đồng ý',
                        action: function () {
                            TraLaiDuChi(id);
                        }
                    },
                    cancel: function () {
                        // do nothing
                    }
                }
            });
        }
    </script>
}
