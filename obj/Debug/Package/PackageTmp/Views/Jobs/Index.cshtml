@*@model IEnumerable<NiceHandles.Models.Job>*@
@using NiceHandles.Models;
@using Microsoft.AspNet.Identity;
@{
    ViewBag.Title = "Index";
    var db = (NiceHandles.Models.NHModel)ViewBag.db;
    var accounts = db.Accounts.Where(x => x.sta == (int)XAccount.eStatus.Processing).ToArray();
    //if (!User.IsInRole("SuperAdmin"))
    //{
    //    var username = User.Identity.GetUserName();
    //    var us = db.Accounts.Where(x => x.UserName.Equals(username)).Single();
    //    var nhom = db.GroupMembers.Where(x => x.account_id == us.id).FirstOrDefault();
    //    if (nhom != null)
    //    {
    //        var members = db.GroupMember_Account.Where(x => x.groupmember_id == nhom.id).Select(x => x.account_id).ToList();
    //        accounts = db.Accounts.Where(x => members.Contains(x.id)).ToArray();
    //    }
    //}
}
<link href="~/Content/Jobs.css" rel="stylesheet" />
<h2>NHIỆM VỤ</h2>
@*<button type="button" class="btn btn-info" onclick="Print();">Bản in tổng</button> &nbsp;*@
<p style="text-align: right;">
    @*<button type="button" class="btn btn-info" onclick="Go();">Đi 1 cửa</button>&nbsp;*@
    @*<button type="button" class="btn btn-primary" onclick="GoDiaChinh();">DS nộp xã</button>&nbsp;*@
    @*<button type="button" class="btn btn-primary" onclick="GoGiayTo();">DS giao nhận giấy tờ</button>&nbsp;
        <button type="button" class="btn btn-info" onclick="AlreadyGo();">DS đi 1 cửa</button>&nbsp;*@
</p>

<div class="row">
    @foreach (var acc in accounts)
    {
        <div class="col-sm-3">
            <h4>@acc.fullname.ToUpper()<button onclick="Print(@acc.id);" class="btn btn-info" style="float: right;">In</button></h4>
            <a onclick="btnNew_click(@acc.id)">Thêm việc mới</a>
            <div class="form-group">
                <ul id="@( "myUL" + acc.id)" class="ulb">
                    @foreach (var item in db.Jobs.Where(x => x.process_by == acc.id && x.status < (int)XJob.eStatus.Complete).OrderByDescending(x => x.start_date).ThenBy(x => x.status))
                    {
                        var lstT = db.tasks.Where(x => x.job_id == item.id).OrderBy(x => x.status);
                        var ca = db.tasks.Where(x => x.job_id == item.id).Count();
                        var cf = db.tasks.Where(x => x.job_id == item.id && x.status == (int)XModels.eStatus.Complete).Count();

                        <li id="@Html.Raw("j" + item.id)">
                            <span class="caret">@Html.Raw(item.name + "(" + cf + "/" + ca + ")") </span><a class="edit" onclick='DelJob_Click(@item.id);'>X</a>
                            <ul class="nested">
                                <li><a onclick='AddTask_Click(this);'>Thêm nhiệm vụ</a>&nbsp;|&nbsp; <a onclick='EditTask_Click(this);'>Xóa</a></li>
                                @foreach (var t in lstT)
                                {
                                    <li>
                                        <input type="checkbox" class="task" id="@t.id" @Html.Raw(t.status == (int)XModels.eStatus.Complete ? "checked" : "") />@t.name
                                        <a class="edit" onclick='DelTask_Click(@t.id);'>X</a>
                                    </li>
                                }
                            </ul>
                        </li>
                    }
                </ul>
            </div>
        </div>
    }
</div>

<div class="modal" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" style="font-size: 16px; color: deeppink; text-align: center;">ĐI 1 CỬA</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-lg-12">

                        <div class="form-horizontal">
                            <div class="form-group">
                                <label class="control-label col-md-2">Hợp đồng</label>
                                <div class="col-md-10">
                                    <select id="cboHopDong" class="form-control"></select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="control-label col-md-2">Ngày nộp</label>
                                <div class="col-md-10">
                                    <input type="text" class="form-control datetime" autocomplete="off" id="txtNgayNop" />
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="control-label col-md-2">Ngày trả KQ</label>
                                <div class="col-md-10">
                                    <input type="text" class="form-control datetime" autocomplete="off" id="txtNgayTraKQ" />
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="control-label col-md-2">Cán bộ 1 cửa</label>
                                <div class="col-md-10">
                                    <input type="text" class="form-control" id="txtCanBo1Cua" />
                                </div>
                            </div>

                            @*<div class="form-group">
                                    <label class="control-label col-md-2">Cán bộ phụ trách</label>
                                    <div class="col-md-10">
                                        <input type="text" class="form-control" id="txtCanBoPhuTrach" />
                                    </div>
                                </div>*@

                            <div class="form-group">
                                <label class="control-label col-md-2">Mã phiếu hẹn</label>
                                <div class="col-md-10">
                                    <input type="text" class="form-control" id="txtMaPhieuHen" />
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="OnGo();">Nộp 1 cửa</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
            </div>
        </div>
    </div>
</div>

<iframe id="my_iframe" style="display:none;"></iframe>
@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    <script src="~/Scripts/Jobs.js"></script>    
}
