@model NiceHandles.Models.XContract
@using NiceHandles.Models
@{
    ViewBag.Title = "Chi tiết";
    var db = new NHModel();
    var lstWF = db.wf_contract.Where(x => x.contract_id == Model.obj.id).ToList();
    var lstOrderWf = new List<xTemp>();
    var grpWf = lstWF.GroupBy(x => x.from_id).Select(x => new { fi = x.Key, LST = x });
    foreach (var item in grpWf.OrderBy(x => x.fi))
    {
        lstOrderWf.AddRange(item.LST.OrderBy(x => x.time).
            Select(x => new xTemp() { date1 = x.time, str1 = x.note, long1 = (x.from_id.HasValue ? x.from_id.Value : 0), int1 = (x.step_id.HasValue ? x.step_id.Value : 0) }));
    }
    var partner = db.Partners.Find(Model.obj.partner);
    var nguoiky = db.Accounts.Find(Model.obj.nguoiky);
    var step = db.Steps.Find(Model.obj.step);
    var service = db.Services.Find(Model.obj.service_id);


    var summeryInout = (from io in db.InOuts
                        join mn in db.Moneys on io.money_code equals mn.code
                        where io.status < (int)XInOut.eStatus.Huy && io.contract_id == Model.obj.id
                        select new { mn.amount, io.type, io.category_id }).ToList();
    var TotalDaThu = summeryInout.Where(x => x.type == (int)XCategory.eType.Thu).Sum(x => x.amount);
    var TotalPhaiThu = Model.obj.amount - TotalDaThu;
    var TotalDaChi = summeryInout.Where(x => x.type == (int)XCategory.eType.Chi).Sum(x => x.amount);
    var TotalDaThuNet = TotalDaThu - TotalDaChi;
    var TotalDuThuNet = Model.obj.amount - Model.obj.consuming;
    //
    var MaxStep = db.Steps.OrderByDescending(x => x.sort).First().sort;
    var CurrentStep = step.sort;
}
<h2>Chi tiết hợp đồng</h2>
<div class="row">
    <div class="col-md-8">
        <div class="row">
            <div class="col-md-6">
                @Html.ActionLink("Nhập thông tin", "Edit", "Infomations", new { contract_id = Model.obj.id }, new { @class = "btn btn-primary" })
                @Html.ActionLink("Chi tiết thực hiện", "Edit", "Infomations", new { contract_id = Model.obj.id }, new { @class = "btn btn-info" })
            </div>
            <div class="col-md-6">
                <h4>Trạng thái hợp đồng: <span style="color:#222"> @XContract.sStatus[Model.obj.status] </span></h4>
            </div>
        </div>
        <div class="row" style="border: 1px solid #0094ff; border-radius: 10px;">
            <div class="col-md-6">
                <dl class="dl-horizontal">
                    <dt>Khách hàng</dt>
                    <dd>@Model.customer_name</dd>
                    <dt>Địa chỉ</dt>
                    <dd>@ViewBag.ADDRESS</dd>
                    <dt>Đối tác</dt>
                    <dd>@partner.name</dd>
                    <dt>Người ký</dt>
                    <dd>@nguoiky.fullname </dd>
                    <dt>Ngày ký</dt>
                    <dd>@Model.obj.time.ToString("dd/MM/yyyy")</dd>
                    <dt>Hạn hoàn thành</dt>
                    <dd>@Model.obj.exp.ToString("dd/MM/yyyy")</dd>
                    <dt>Số ngày đã thực hiện</dt>
                    <dd>@( (DateTime.Now - Model.obj.time).TotalDays)</dd>
                    <dt>Số ngày quá hạn</dt>
                    <dd>@Html.Raw((DateTime.Now - Model.obj.exp).TotalDays > 0 ? (DateTime.Now - Model.obj.exp).TotalDays.ToString() : "-")</dd>
                    <dt>Bước đang thực hiện</dt>
                    <dd>@step.name</dd>
                    <dt>Tải file hợp đồng</dt>
                    <dd id="contract@(Model.obj.id)">
                        @if (string.IsNullOrEmpty(Model.obj.HardFileLink))
                        {
                            <a class="aHardFile view fa fa-eye text-danger" href="#">No File</a>
                        }
                        else
                        {
                            <a class="aHardFile view fa fa-eye" href="@Model.obj.HardFileLink" target="_blank">Xem file</a>
                        } |
                        <a class="fa fa-save" onclick="HardFileUpdate(@Model.obj.id)"> Up file</a>
                    </dd>
                </dl>
            </div>
            <div class="col-md-6">
                <dl class="dl-horizontal">
                    <dt>Dịch vụ</dt>
                    <dd>@service.name</dd>
                    <dt>Mức độ ưu tiên</dt>
                    <dd>@XContract.sPriority[Model.obj.Priority]</dd>
                    <dt>Giá trị hợp đồng</dt>
                    <dd>@Model.obj.amount.ToString("N0")</dd>
                    <dt>Dự chi</dt>
                    <dd>@Model.obj.consuming.ToString("N0")</dd>
                    <dt>Đã thu</dt>
                    <dd>@TotalDaThu.ToString("N0")</dd>
                    <dt>Phải thu</dt>
                    <dd>@TotalPhaiThu.ToString("N0")</dd>
                    <dt>Đã chi</dt>
                    <dd>@TotalDaChi.ToString("N0")</dd>
                    <dt>Đã thu NET</dt>
                    <dd>@TotalDaThuNet.ToString("N0") </dd>
                    <dt>Dự thu NET</dt>
                    <dd>@TotalDuThuNet.ToString("N0")</dd>
                </dl>
            </div>

            @if (!string.IsNullOrEmpty(Model.obj.note))
            {
                <div class="col-md-12 text-danger">
                    @Html.Raw(Model.obj.note)
                </div>
            }

        </div>
        <p>
            @Html.ActionLink("Chỉnh sửa", "Edit", new { id = Model.obj.id }) |
            @Html.ActionLink("Về danh sách", "Index")
        </p>
    </div>
    <div class="col-md-4">
        <div id="chartContainer" style="height: 250px; width: 100%;"></div>
        <h4 style="text-align: center">Tiến độ thực hiện</h4>
        @*<h4>Tải tài liệu</h4>
            <ul>
                @foreach (var t in XDocument.sType)
                {
                    <li>
                        <label style="color: deeppink; text-transform: uppercase;">@t.Value</label>
                        <ul>

                            @foreach (var document in Common.GetDocumentsByService(Model.obj.service_id).Where(x => x.type == t.Key))
                            {
                                <li>
                                    <a href="javascript:Download(@document.id,@Model.obj.id)">@document.name</a>
                                </li>
                            }
                        </ul>
                    </li>
                }
            </ul>*@
    </div>
</div>
<div class="row block">
    <div class="col-sm-12">
        <h4>Thu chi</h4>
        <hr />
        <p>
            @Html.ActionLink("Thêm mới", "Create", "InOuts", new { id = Model.obj.id }, new { @class = "btn btn-primary" })
        </p>
        <table class="table table-hover">
            <tr>
                <th>
                    Loại thu chi
                </th>
                <th>
                    Người thực hiện
                </th>
                <th>
                    Số tiền
                </th>
                <th>
                    Ghi chú
                </th>
                <th>
                    Thời gian
                </th>
                <th>
                </th>
            </tr>
            @foreach (var item in Model.lst_xsinouts)
            {
                <tr class="@(item.obj.type==(int)XCategory.eType.Chi ? "text-danger" : null )">
                    <td>
                        @item.category_name
                    </td>
                    <td>
                        @item.account_name
                    </td>
                    <td>
                        @item.amount.ToString("N0")
                    </td>
                    <td>
                        @item.obj.note
                    </td>
                    <td>
                        @item.obj.time.ToString("dd/MM/yyyy")
                    </td>
                    <td>
                        @Html.ActionLink("Sửa", "Edit", "InOuts", new { id = item.obj.id }, null) |
                        @Html.ActionLink("Chi tiết", "Details", "InOuts", new { id = item.obj.id }, null) |
                        @Html.ActionLink("Xóa", "Delete", "InOuts", new { id = item.obj.id }, null)
                    </td>
                </tr>
            }
        </table>
    </div>
</div>
<div class="row">
    <div class="col-sm-12">
        <h4> Quá trình </h4>
        <hr />
        <p>
            @Html.ActionLink("Thêm mới", "Create", "wf_contract", new { id = Model.obj.id }, new { @class = "btn btn-primary" })
        </p>
        <table class="table table-hover">
            <tr>
                <th>
                    Người thực hiện
                </th>
                <th>
                    Thời gian
                </th>
                <th>
                    Ghi chú
                </th>
                <th>
                    Trạng thái
                </th>
                <th>
                </th>
            </tr>
            @foreach (var item in Model.lst_wf)
            {
                <tr>
                    <td>
                        @item.account_name
                    </td>
                    <td>
                        @item.obj.time.ToString("dd/MM/yyyy")
                    </td>
                    <td>
                        @item.obj.note
                    </td>
                    <td>
                        @NiceHandles.Models.Xwf_contract.sStatus[item.obj.status]
                    </td>
                    <td>
                        @Html.ActionLink("Sửa", "Edit", "wf_contract", new { id = item.obj.id }, null) |
                        @Html.ActionLink("Chi tiết", "Details", "wf_contract", new { id = item.obj.id }, null) |
                        @Html.ActionLink("Xóa", "Delete", "wf_contract", new { id = item.obj.id }, null)
                    </td>
                </tr>
            }
        </table>

        <div class="form-horizontal">
            <hr />
            @foreach (var item in lstOrderWf.GroupBy(x => x.long1))
            {
                var tempColor = item.First().int1 == 0 ? 1 : item.First().int1;
                var color = db.Steps.Find(tempColor).color;
                <div class="form-group" style="background-color: @color; color: #fff; border-radius: 10px; padding: 10px;">
                    @foreach (var per in item.OrderBy(x => x.date1))
                    {
                        <div class="col-md-2">
                            @per.date1.ToString("dd/MM/yyyy")
                        </div>
                        <div class="col-md-10" style="text-align: center;">
                            @per.str1
                        </div>
                    }
                </div>
            }
        </div>
    </div>
</div>
@Html.Partial("_ModalHardFileUpdate")
<iframe id="my_iframe" style="display:none;"></iframe>
@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    <script src="~/Scripts/moment.min.js"></script>
    <script src="https://cdn.canvasjs.com/canvasjs.min.js"></script>
    <script src="~/Scripts/nicehandle.js"></script>
    <script>
        function Download(id, contract_id) {
            $.ajax({
                url: '/Infomations/Download',
                data: { d: id, c: contract_id },
                type: "GET",
                dataType: "JSON",
                success: function (url) {
                    document.getElementById('my_iframe').src = url;
                }
            });
        }
        $(document).ready(function () {
            var chart = new CanvasJS.Chart("chartContainer", {
                animationEnabled: true,
                title: {
                    /*text: "17%",*/
                    horizontalAlign: "center",
                },
                data: [{
                    type: "doughnut",
                    startAngle: 50,
                    innerRadius: 50,
                    indexLabelFontSize: 17,
                    //indexLabel: "{label} - #percent%",
                    //toolTipContent: "<b>{label}:</b> {y} (#percent%)",
                    dataPoints: [
                        { y: @CurrentStep, label: "" },
                        { y: @(MaxStep-CurrentStep), label: "" },
                    ]
                }]
            });
            chart.render();

        });
    </script>
}
