@model PagedList.IPagedList<NiceHandles.Models.vContractHardFile>
@using PagedList.Mvc;
@using NiceHandles.Models

@{
    ViewBag.Title = "Hợp đồng";
    var db = new NHModel();
    var ADDRESS = new SelectList(db.Addresses, "id", "name");
    var SERVICES = new SelectList(db.Services, "id", "name");
    var PARTNER = new SelectList(db.Partners.OrderBy(x => x.sothutu), "id", "name");
}

<h2>Hợp đồng</h2>

@using (Html.BeginForm("ViewHardFile", "Contracts", FormMethod.Get))
{
    <div class="row">
        <div class="col-sm-2">
            <div class="form-group">
                @Html.TextBox("Search_Data", ViewBag.FilterValue as string, new { @class = "form-control", placeholder = "Tìm kiếm" })
            </div>
        </div>
        <div class="col-sm-2">
            <div class="form-group">
                @Html.DropDownList("add", ADDRESS, "--- Địa chỉ ---", new { @class = "form-control", title = "Địa chỉ" })
            </div>
        </div>
        <div class="col-sm-2">
            <div class="form-group">
                @Html.DropDownList("ser", SERVICES, "--- Dịch vụ ---", new { @class = "form-control", title = "Dịch vụ" })
            </div>
        </div>
        <div class="col-sm-2">
            <div class="form-group">
                @Html.DropDownList("par", PARTNER, "--- Đối tác ---", new { @class = "form-control", title = "Đối tác" })
            </div>
        </div>
        <div class="col-lg-2">
            <div class="form-group">
                <button type="submit" class="btn btn-danger" style="height: 32px; width: 100px;">Tìm kiếm</button>
            </div>
        </div>
    </div>
}
<table class="table table-hover">
    <tr>
        <th>
            Tên khách hàng
        </th>
        <th>
            Địa chỉ
        </th>
        <th>
            Dịch vụ
        </th>
        <th>
            Đối tác
        </th>
        <th>
            Ngày ký
        </th>
        <th>
            HĐ cứng
        </th>
    </tr>

    @foreach (var item in Model)
    {
        if (item != null)
        {
            <tr>
                <td>
                    @Html.ActionLink(item.customer_name, "Details", new { id = item.id })
                </td>
                <td>
                    @Html.ActionLink(item.address_name, "Details", new { id = item.id })
                </td>
                <td>
                    @item.service_name
                </td>
                <td>
                    @item.partner_name
                </td>
                <td>
                    @item.time.ToString("dd/MM/yyyy")
                </td>
                <td id="@item.id">
                    @if (string.IsNullOrEmpty(item.HardFileLink))
                    {
                        <a class="view fa fa-eye text-danger" href="#">No File</a>
                    }
                    else
                    {
                        <a class="view fa fa-eye" href="@item.HardFileLink" target="_blank">Xem file</a>
                    } |
                    <a class="fa fa-save" onclick="Update(@item.id)"> Sửa file</a>
                </td>
            </tr>
        }
    }
</table>
@if (Model.PageCount > 1)
{
    <div class="row" style="margin-top: 10px;">
        <div class="col-sm-1">
            Trang @(Model.PageCount < Model.PageNumber ? 0 : Model.PageNumber) / @Model.PageCount
        </div>
        <div class="col-sm-10">
            @Html.PagedListPager(Model, Page_No => Url.Action("ViewHardFile", new { Page_No, Filter_Value = ViewBag.FilterValue, add = ViewBag.ADD, ser = ViewBag.SER, par = ViewBag.PAR }))
        </div>
    </div>
}
<div id="mdlViewDown" class="modal" role="dialog" tabindex="-1">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" style="font-size: 16px; color: deeppink; text-align: center;">Xem/Tải lên</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="form-horizontal">
                            <div class="form-group">
                                <label class="col-sm-2"> </label>
                                <form id="frmUpload" class="col-sm-10">
                                    <input id="hdId" type="hidden" />
                                    <input id="hdType" type="hidden" />
                                    <input id="flUpload" type="file" style="display: inline-block;" class="btn btn-primary" />
                                    <input type="submit" value="Upload" class="btn btn-primary" />
                                </form>
                            </div>

                        </div>

                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng lại</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    <script type="text/javascript">
        $(document).ready(function () {
            $('#frmUpload').on("submit", function (event) {
                var frm = this;
                var id = current;
                var formdata = new FormData(); //FormData object
                var fileInput = $(':file', this)[0];
                for (i = 0; i < fileInput.files.length; i++) {
                    formdata.append(fileInput.files[i].name, fileInput.files[i]);
                }
                formdata.append("id", id);
                var xhr = new XMLHttpRequest();
                xhr.open('POST', '/contracts/UploadHardFile');
                xhr.send(formdata);
                xhr.onreadystatechange = function () {
                    if (xhr.readyState == 4 && xhr.status == 200) {
                        $("#" + id + " .view").removeClass("text-danger").prop("href", JSON.parse(xhr.responseText)).attr("target", "_blank").text("Xem file");
                    }
                }
                $("#mdlViewDown").modal("hide");
                event.preventDefault();
            });
        });
        var current;
        function Update(id) {
            current = id;
            $("#mdlViewDown").modal("show");
        }
    </script>
}